<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRIPSODA - ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/post-create.css}">
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxNabOta7u8Pj4FJuD0rdAKeGfOOEPrcE&libraries=places&callback=initLocationSearch&language=ko&region=KR">
    </script>
</head>
<body>
<div class="container">
    <!-- ì™¼ìª½ ë°°ë„ˆ ì˜ì—­ -->
    <div th:replace="~{layout/fragments/banner :: banner}"></div>


    <!-- ì˜¤ë¥¸ìª½ ì½˜í…ì¸  ì˜ì—­ -->
    <div class="right-content">
        <!-- í—¤ë” -->
        <header th:replace="~{layout/fragments/header :: header}"></header>

        <!-- ì½˜í…ì¸  -->
        <div class="content">
            <!-- ê²Œì‹œê¸€ ì‘ì„± í—¤ë” -->
            <div class="write-post-header">
                <div class="back-button" id="backButton">
                    <i class="fas fa-arrow-left"></i>
                    <span>ë’¤ë¡œ ê°€ê¸°</span>
                </div>
                <h2 class="write-post-title">ê²Œì‹œê¸€ ì‘ì„±</h2>
                <div style="width: 80px;"></div> <!-- ê· í˜•ì„ ìœ„í•œ ë¹ˆ ê³µê°„ -->
            </div>

            <!-- ê²Œì‹œê¸€ ì‘ì„± í¼ -->
            <div class="post-form-container">
                <form th:action="@{/post/create}" th:method="post" id="postForm">
                    <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
                    <div class="form-group">
                        <label class="form-label">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                        <div class="category-select">
                            <div class="category-option active" data-category="post">
                                <i class="fas fa-pen-nib"></i>
                                <span>ì¼ë°˜ í¬ìŠ¤íŠ¸</span>
                            </div>
                            <div class="category-option" data-category="companion">
                                <i class="fas fa-user-friends"></i>
                                <span>ë™í–‰</span>
                            </div>
                            <div class="category-option" data-category="route">
                                <i class="fas fa-route"></i>
                                <span>ì¶”ì²œ ì—¬í–‰ê²½ë¡œ</span>
                            </div>
                            <div class="category-option" data-category="review">
                                <i class="fas fa-star"></i>
                                <span>ë¦¬ë·°</span>
                            </div>
                        </div>
                    </div>

                    <!-- ì œëª© ì…ë ¥ -->
                    <div class="form-group">
                        <label class="form-label" for="postTitle">ì œëª©</label>
                        <input type="text" id="postTitle" name="title" class="form-control" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                               maxlength="100">
                        <div class="character-count"><span id="titleCount">0</span>/100</div>
                        <div class="form-error" id="titleError">ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                    </div>

                    <!-- íƒœê·¸ ì…ë ¥ -->
                    <div class="form-group">
                        <label class="form-label">íƒœê·¸</label>
                        <div class="tags-input-container" id="tagsContainer">
                            <input type="text" class="tag-input" id="tagInput" placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  Enter í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”">
                        </div>
                        <span class="form-hint">ìµœëŒ€ 5ê°œê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê° íƒœê·¸ëŠ” '#'ìœ¼ë¡œ ì‹œì‘í•˜ë©° 15ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.</span>
                        <div class="form-error" id="tagsError">íƒœê·¸ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
                    </div>

                    <!-- ë‚´ìš© ì…ë ¥ -->
                    <div class="form-group">
                        <label class="form-label" for="postContent">ë‚´ìš©</label>
                        <textarea id="postContent" name="content" class="form-control form-textarea"
                                  placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" maxlength="3000" required></textarea>
                        <div class="character-count"><span id="contentCount">0</span>/3000</div>
                        <div class="form-error" id="contentError">ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                    </div>

                    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                    <div class="form-group">
                        <label class="form-label">ì´ë¯¸ì§€</label>
                        <span class="form-hint">ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (jpg, png, gif í˜•ì‹, ê° 5MB ì´í•˜)</span>
                        <div class="image-upload-container">
                            <div class="image-preview-area" id="imagePreviewArea">
                                <label for="imageUpload" class="image-upload-btn">
                                    <i class="fas fa-plus"></i>
                                    <span>ì´ë¯¸ì§€ ì¶”ê°€</span>
                                </label>
                            </div>
                            <input type="file" id="imageUpload" accept="image/jpeg, image/png, image/gif"
                                   style="display: none;"
                                   multiple>
                        </div>
                        <div class="form-error" id="imageError">ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
                    </div>

                    <!-- ìœ„ì¹˜ ì •ë³´ -->
                    <div class="form-group">
                        <label class="form-label">ìœ„ì¹˜ ì •ë³´ (ì„ íƒ)</label>
                        <div class="location-search-container">
                            <div class="location-search-box">
                                <input type="text" id="locationSearch" class="location-search-input"
                                       placeholder="ìœ„ì¹˜ ê²€ìƒ‰ (ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬)">
                                <button type="button" id="searchLocationBtn" class="location-search-btn">ê²€ìƒ‰</button>
                            </div>
                            <div class="location-preview" id="locationPreview">
                                <img src="/api/placeholder/500/200" alt="ìœ„ì¹˜ ì§€ë„" class="location-preview-map">
                                <div class="location-preview-info">
                                    <div class="location-preview-name">ì¥ì†Œëª…</div>
                                    <div class="location-preview-address">ì£¼ì†Œ ì •ë³´</div>
                                </div>
                                <div class="location-preview-remove" id="removeLocation">
                                    <i class="fas fa-times"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- í¼ ì•¡ì…˜ ë²„íŠ¼ -->
                    <div class="form-actions">
                        <button type="button" id="cancelBtn" class="cancel-btn">ì·¨ì†Œ</button>
                        <button type="submit" id="submitBtn" class="submit-btn">ê²Œì‹œí•˜ê¸°</button>
                    </div>
                </form>
            </div>

            <!-- ìœ„ì¹˜ ê²€ìƒ‰ ëª¨ë‹¬ -->
            <div class="modal" id="locationModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ìœ„ì¹˜ ì„ íƒ</div>
                        <div class="modal-close" id="closeLocationModal"><i class="fas fa-times"></i></div>
                    </div>
                    <div class="modal-body">
                        <div id="locationResults" style="max-height: 300px; overflow-y: auto;">
                            <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            <div class="location-item"
                                 style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: all 0.3s ease;">
                                <div style="font-weight: 600; margin-bottom: 5px;">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‚¼ì„±ë™</div>
                                <div style="font-size: 0.9rem; color: #666;">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‚¼ì„±ë™ 159</div>
                            </div>
                            <div class="location-item"
                                 style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: all 0.3s ease;">
                                <div style="font-weight: 600; margin-bottom: 5px;">ê°•ë‚¨ ìŠ¤íƒ€ë²…ìŠ¤</div>
                                <div style="font-size: 0.9rem; color: #666;">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 107</div>
                            </div>
                            <div class="location-item"
                                 style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: all 0.3s ease;">
                                <div style="font-weight: 600; margin-bottom: 5px;">ê°•ë‚¨ì—­</div>
                                <div style="font-size: 0.9rem; color: #666;">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ê°•ë‚¨ëŒ€ë¡œ 396</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
        <div class="toast" id="toast">ì•Œë¦¼ ë©”ì‹œì§€</div>
    </div>
</div>

<script>

    // Google Maps API ê´€ë ¨ ë³€ìˆ˜ë“¤
    let map;
    let service;

    // Google Maps API ì´ˆê¸°í™” í•¨ìˆ˜
    function initGoogleMaps() {
        // ìˆ¨ê²¨ì§„ ë§µ ìƒì„± (Places API ì‚¬ìš©ì„ ìœ„í•´ í•„ìš”)
        map = new google.maps.Map(document.createElement('div'));
        service = new google.maps.places.PlacesService(map);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ Google Maps ì´ˆê¸°í™”
    window.initLocationSearch = initGoogleMaps;

    $(document).ready(function () {
        // ì¹´í…Œê³ ë¦¬ ì„ íƒ
        $('.category-option').click(function () {
            $('.category-option').removeClass('active');
            $(this).addClass('active');
        });

        // ì œëª© ê¸€ììˆ˜ ì¹´ìš´íŠ¸
        $('#postTitle').on('input', function () {
            const length = $(this).val().length;
            $('#titleCount').text(length);

            if (length > 0) {
                $('#titleError').hide();
            }
        });

        // ë‚´ìš© ê¸€ììˆ˜ ì¹´ìš´íŠ¸
        $('#postContent').on('input', function () {
            const length = $(this).val().length;
            $('#contentCount').text(length);

            if (length > 0) {
                $('#contentError').hide();
            }
        });

        // íƒœê·¸ ì…ë ¥ ì²˜ë¦¬
        $('#tagInput').on('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();

                const tagText = $(this).val().trim();
                if (!tagText) return;

                // íƒœê·¸ í˜•ì‹ í™•ì¸ (# ë¶™ì´ê¸°)
                let tagName = tagText;
                if (!tagName.startsWith('#')) {
                    tagName = '#' + tagName;
                }

                // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸ì¸ì§€ í™•ì¸
                let tagExists = false;
                $('.tag').each(function () {
                    if ($(this).data('tag') === tagName) {
                        tagExists = true;
                        return false;
                    }
                });

                if (tagExists) {
                    showToast('ì´ë¯¸ ì¶”ê°€ëœ íƒœê·¸ì…ë‹ˆë‹¤');
                    return;
                }

                // íƒœê·¸ ê°œìˆ˜ ì œí•œ í™•ì¸
                if ($('.tag').length >= 5) {
                    $('#tagsError').text('íƒœê·¸ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤').show();
                    return;
                }

                // íƒœê·¸ ê¸¸ì´ ì œí•œ í™•ì¸
                if (tagName.length > 15) {
                    $('#tagsError').text('íƒœê·¸ëŠ” 15ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”').show();
                    return;
                }

                // ìƒˆ íƒœê·¸ ì¶”ê°€
                const newTag = $('<div class="tag" data-tag="' + tagName + '">' + tagName + '<div class="tag-close"><i class="fas fa-times"></i></div></div>');
                $(this).before(newTag);
                $(this).val('');

                // íƒœê·¸ ì‚­ì œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                newTag.find('.tag-close').click(function () {
                    $(this).parent().remove();
                    $('#tagsError').hide();
                });
            }
        });

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        $('#imageUpload').change(function (e) {
            const files = e.target.files;
            const currentImages = $('.image-preview-item').length - 1; // ì—…ë¡œë“œ ë²„íŠ¼ ì œì™¸

            // ìµœëŒ€ ì´ë¯¸ì§€ ìˆ˜ ì œí•œ í™•ì¸
            if (currentImages + files.length > 5) {
                $('#imageError').show();
                return;
            } else {
                $('#imageError').hide();
            }

            // ê° íŒŒì¼ ì²˜ë¦¬
            for (let i = 0; i < files.length; i++) {
                if (currentImages + i >= 5) break;

                const file = files[i];

                // íŒŒì¼ ìœ í˜• ë° í¬ê¸° í™•ì¸
                if (!file.type.match('image/jpeg') && !file.type.match('image/png') && !file.type.match('image/gif')) {
                    showToast('JPG, PNG, GIF í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                    continue;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB
                    showToast('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                    continue;
                }

                // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imagePreview = $('<div class="image-preview-item">' +
                        '<img src="' + e.target.result + '" class="image-preview-img">' +
                        '<div class="image-preview-remove"><i class="fas fa-times"></i></div>' +
                        '</div>');

                    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì´ë¯¸ì§€ ì¶”ê°€ ë²„íŠ¼ ì•ì— ì¶”ê°€
                    imagePreview.insertBefore('.image-upload-btn');

                    // ì´ë¯¸ì§€ ì‚­ì œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                    imagePreview.find('.image-preview-remove').click(function () {
                        $(this).parent().remove();
                        $('#imageError').hide();
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // ìœ„ì¹˜ ê²€ìƒ‰ ì²˜ë¦¬ (Google Places APIë¡œ ìˆ˜ì •)
        $('#searchLocationBtn').click(function () {
            const locationQuery = $('#locationSearch').val().trim();
            if (!locationQuery) {
                showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            if (!service) {
                showToast('ì§€ë„ ì„œë¹„ìŠ¤ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê²€ìƒ‰ ë²„íŠ¼ ë¡œë”© ìƒíƒœ
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ê²€ìƒ‰ì¤‘...');

            // Google Places Text Search ì‹¤í–‰
            const request = {
                query: locationQuery,
                fields: ['place_id', 'name', 'formatted_address', 'geometry', 'types']
            };

            service.textSearch(request, (results, status) => {
                // ê²€ìƒ‰ ë²„íŠ¼ ì›ìƒë³µêµ¬
                $('#searchLocationBtn').prop('disabled', false).html('ê²€ìƒ‰');

                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê¸°ì¡´ ëª¨ë‹¬ í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
                    displayGooglePlacesResults(results);
                    openLocationModal();
                } else {
                    showToast('ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.');
                }
            });
        });

        // Google Places ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê¸°ì¡´ ëª¨ë‹¬ í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
        function displayGooglePlacesResults(results) {
            let resultsHtml = '';

            results.forEach(place => {
                // ì¥ì†Œëª…ê³¼ ì£¼ì†Œë¥¼ ëª…í™•íˆ êµ¬ë¶„
                const placeName = place.name || 'ì¥ì†Œëª… ì—†ìŒ';
                const placeAddress = place.formatted_address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';

                resultsHtml += `
                    <div class="location-item"
                         data-place-id="${place.place_id}"
                         data-place-name="${placeName}"
                         data-place-address="${placeAddress}"
                         style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: all 0.3s ease;">
                        <div style="font-weight: 600; margin-bottom: 5px; color: #2c3e50;">${placeName}</div>
                        <div style="font-size: 0.9rem; color: #666;">ğŸ“ ${placeAddress}</div>
                    </div>
                `;
            });

            $('#locationResults').html(resultsHtml);
        }

        // ìœ„ì¹˜ ëª¨ë‹¬ ì—´ê¸°
        function openLocationModal() {
            $('#locationModal').addClass('active');
        }

        // ìœ„ì¹˜ ëª¨ë‹¬ ë‹«ê¸°
        $('#closeLocationModal').click(function () {
            $('#locationModal').removeClass('active');
        });

        // ìœ„ì¹˜ ì„ íƒ ì²˜ë¦¬ (ê¸°ì¡´ ì½”ë“œ + Place ID ì €ì¥ + ì§€ë„ í‘œì‹œ ì¶”ê°€)
        $(document).on('click', '.location-item', function () {
            const placeId = $(this).data('place-id');
            const placeName = $(this).data('place-name');
            const placeAddress = $(this).data('place-address');

            // ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€
            const locationName = $(this).find('div:first').text();
            const locationAddress = $(this).find('div:last').text();

            $('#locationPreview').find('.location-preview-name').text(locationName);
            $('#locationPreview').find('.location-preview-address').text(locationAddress);

            // ì§€ë„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ (Google Static Maps API ì‚¬ìš©)
            if (placeId) {
                updateLocationMap(placeId, placeName);
            } else {
                // Place IDê°€ ì—†ìœ¼ë©´ ì£¼ì†Œë¡œ ì§€ë„ ìƒì„±
                updateLocationMapByAddress(placeAddress || locationAddress);
            }

            $('#locationPreview').show();
            $('#locationModal').removeClass('active');

            // ì¶”ê°€: Place IDì™€ ì¥ì†Œëª…ì„ hidden inputìœ¼ë¡œ ì €ì¥
            // ê¸°ì¡´ hidden input ì œê±°
            $('#hiddenPlaceId, #hiddenPlaceName, #hiddenPlaceAddress').remove();

            // ìƒˆ hidden input ì¶”ê°€
            $('#postForm').append(`
                <input type="hidden" id="hiddenPlaceId" name="placeId" value="${placeId || ''}">
                <input type="hidden" id="hiddenPlaceName" name="placeName" value="${placeName || locationName}">
                <input type="hidden" id="hiddenPlaceAddress" name="placeAddress" value="${placeAddress || locationAddress}">
            `);

            console.log('ì„ íƒëœ ìœ„ì¹˜:', {
                placeId: placeId,
                placeName: placeName || locationName,
                placeAddress: placeAddress || locationAddress
            });
        });

        // ì§€ë„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (Place ID ì‚¬ìš©)
        function updateLocationMap(placeId, placeName) {
            // Google Static Maps APIë¥¼ ì‚¬ìš©í•´ì„œ ì§€ë„ ì´ë¯¸ì§€ ìƒì„±
            const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?` +
                `center=place_id:${placeId}&` +
                `zoom=16&` +
                `size=500x200&` +
                `markers=color:red%7Cplace_id:${placeId}&` +
                `key=AIzaSyBxNabOta7u8Pj4FJuD0rdAKeGfOOEPrcE&` +
                `language=ko&region=KR`;

            $('#locationPreview').find('.location-preview-map').attr('src', mapUrl);
        }

        // ì§€ë„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì£¼ì†Œ ì‚¬ìš©)
        function updateLocationMapByAddress(address) {
            const encodedAddress = encodeURIComponent(address);
            const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?` +
                `center=${encodedAddress}&` +
                `zoom=16&` +
                `size=500x200&` +
                `markers=color:red%7C${encodedAddress}&` +
                `key=AIzaSyBxNabOta7u8Pj4FJuD0rdAKeGfOOEPrcE&` +
                `language=ko&region=KR`;

            $('#locationPreview').find('.location-preview-map').attr('src', mapUrl);
        }

        // ìœ„ì¹˜ ì‚­ì œ
        $('#removeLocation').click(function () {
            $('#locationPreview').hide();
            $('#locationSearch').val('');

            // ì¶”ê°€: hidden inputë“¤ë„ ì œê±°
            $('#hiddenPlaceId, #hiddenPlaceName, #hiddenPlaceAddress').remove();
        });

        // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
        $('#backButton').click(function () {
            if ($('#postTitle').val() || $('#postContent').val() || $('.tag').length > 0 || $('.image-preview-item').length > 1) {
                if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.history.back();
                }
            } else {
                window.history.back();
            }
        });

        // ì·¨ì†Œ ë²„íŠ¼
        $('#cancelBtn').click(function () {
            if ($('#postTitle').val() || $('#postContent').val() || $('.tag').length > 0 || $('.image-preview-item').length > 1) {
                if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.history.back();
                }
            } else {
                window.history.back();
            }
        });

        // í¼ ì œì¶œ ì²˜ë¦¬
        $('#postForm').submit(function (e) {
            e.preventDefault();

            // ìœ íš¨ì„± ê²€ì¦
            let isValid = true;

            // ì œëª© ê²€ì¦
            const title = $('#postTitle').val().trim();
            if (!title) {
                $('#titleError').show();
                isValid = false;
            }

            // ë‚´ìš© ê²€ì¦
            const content = $('#postContent').val().trim();
            if (!content) {
                $('#contentError').show();
                isValid = false;
            }

            // í¼ì´ ìœ íš¨í•˜ë©´ ì œì¶œ
            if (isValid) {
                // íƒœê·¸ ìˆ˜ì§‘
                const tags = [];
                $('.tag').each(function () {
                    tags.push($(this).data('tag'));
                });

                // ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
                const category = $('.category-option.active').data('category');

                // ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ì½”ë“œ + Place ID ì¶”ê°€)
                let location = null;
                if ($('#locationPreview').is(':visible')) {
                    const placeId = $('#hiddenPlaceId').val();
                    const placeName = $('#hiddenPlaceName').val();
                    const placeAddress = $('#hiddenPlaceAddress').val();

                    location = {
                        name: $('#locationPreview').find('.location-preview-name').text(),
                        address: $('#locationPreview').find('.location-preview-address').text(),
                        placeId: placeId,        // ì¶”ê°€
                        placeName: placeName,    // ì¶”ê°€
                        placeAddress: placeAddress // ì¶”ê°€
                    };
                }

                // ë°ì´í„° ê°ì²´ ìƒì„±
                const postData = {
                    title: title,
                    content: content,
                    category: category,
                    tags: tags,
                    location: location
                    // ì´ë¯¸ì§€ëŠ” FormDataë¡œ ë³„ë„ ì²˜ë¦¬í•´ì•¼ í•¨
                };

                console.log('ê²Œì‹œê¸€ ë°ì´í„°:', postData);

                // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” AJAXë¥¼ í†µí•´ ì„œë²„ë¡œ ì „ì†¡
                showToast('ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');

                // ì„±ê³µ ì‹œ ë¦¬ë””ë ‰ì…˜ (ì‹¤ì œ êµ¬í˜„ ì‹œ ì„œë²„ ì‘ë‹µ í›„ ì²˜ë¦¬)
                setTimeout(function () {
                    // window.location.href = '/community';
                    alert('ê²Œì‹œê¸€ ë“±ë¡ ì™„ë£Œ (í…ŒìŠ¤íŠ¸) - Place ID: ' + (location?.placeId || 'ì—†ìŒ'));
                }, 1500);
            } else {
                // ì²« ë²ˆì§¸ ì˜¤ë¥˜ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
                const firstError = $('.form-error:visible').first();
                if (firstError.length) {
                    $('html, body').animate({
                        scrollTop: firstError.offset().top - 100
                    }, 500);
                }
            }
        });

        /*var msg = [[${msg}]];
        console.log(msg)*/

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
        function showToast(message) {
            const toast = $('#toast');

            //ìœ íš¨ì„± í…ŒìŠ¤íŠ¸í•˜ê¸°
            if (msg) {
                toast.text(message);
                toast.addClass('show');

                setTimeout(function () {
                    toast.removeClass('show');
                }, 3000);

            }
        }

        // ìœ„ì¹˜ ëª¨ë‹¬ ë‚´ ì•„ì´í…œ í˜¸ë²„ íš¨ê³¼
        $(document).on('mouseenter', '.location-item', function () {
            $(this).css('background-color', 'var(--primary-light)');
        }).on('mouseleave', '.location-item', function () {
            $(this).css('background-color', '');
        });
    });
</script>

</body>
</html>