<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<th:block layout:fragment="style">
  <link rel="stylesheet" th:href="@{/css/post-create.css}">

  <!-- Google Maps JavaScript API ì¶”ê°€ (Geocoding APIë„ í¬í•¨) -->
  <script async defer
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxNabOta7u8Pj4FJuD0rdAKeGfOOEPrcE&libraries=places&callback=initLocationSearch">
  </script>

  <style>
    /* ìœ„ì¹˜ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .location-search-container {
        position: relative;
        width: 100%;
    }

    .location-search-box {
        display: flex;
        gap: 8px;
    }

    .location-search-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
    }

    .location-search-input:focus {
        border-color: #007bff;
    }

    .location-search-btn {
        padding: 12px 20px;
        background: #0ED8D5;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .location-search-btn:hover {
        background: #0BC5C2;
    }

    .location-search-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* ê²€ìƒ‰ ê²°ê³¼ ë“œë¡­ë‹¤ìš´ */
    .location-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .location-dropdown.dropup {
        top: auto;
        bottom: 100%;
        border-top: 1px solid #ddd;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    }

    .location-dropdown.show {
        display: block;
    }

    .location-dropdown::-webkit-scrollbar {
        width: 6px;
    }

    .location-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .location-dropdown::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .location-dropdown::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .location-dropdown-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .location-dropdown-item:last-child {
        border-bottom: none;
    }

    .location-dropdown-item:hover {
        background-color: #f8f9fa;
    }

    .location-dropdown-item.active {
        background-color: #e7f3ff;
    }

    .location-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
        font-size: 14px;
    }

    .location-address {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
    }

    .location-type {
        font-size: 11px;
        color: #999;
        margin-top: 2px;
    }

    .location-preview {
        display: none;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 12px;
        position: relative;
    }

    .location-preview-map {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .location-preview-info {
        padding: 12px 16px;
        background: white;
    }

    .location-preview-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }

    .location-preview-address {
        font-size: 13px;
        color: #666;
        line-height: 1.4;
    }

    .location-preview-remove {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 32px;
        height: 32px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .location-preview-remove:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    .location-search-loading {
        padding: 12px 16px;
        text-align: center;
        color: #666;
        font-size: 14px;
    }

    .location-search-no-results {
        padding: 12px 16px;
        text-align: center;
        color: #999;
        font-size: 14px;
    }

    .image-file-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        color: white;
        padding: 8px 6px 4px;
        border-radius: 0 0 8px 8px;
        font-size: 10px;
    }

    .file-name {
        font-weight: 500;
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-size {
        opacity: 0.8;
    }

    .image-preview-item {
        position: relative;
        display: inline-block;
        margin-right: 8px;
        margin-bottom: 8px;
    }

    .image-preview-img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .image-preview-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 24px;
        height: 24px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.3s ease;
    }

    .image-preview-remove:hover {
        background: rgba(255, 0, 0, 1);
    }

    /* ê¸°ì¡´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .existing-images {
        margin-bottom: 16px;
    }

    .existing-image-item {
        position: relative;
        display: inline-block;
        margin-right: 8px;
        margin-bottom: 8px;
    }

    .existing-image-checkbox {
        position: absolute;
        top: 4px;
        left: 4px;
        width: 20px;
        height: 20px;
        z-index: 10;
    }

    .existing-image-label {
        position: absolute;
        top: 4px;
        left: 26px;
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        color: #333;
        z-index: 10;
    }

    .existing-image-item.to-delete {
        opacity: 0.5;
    }

    .existing-image-item.to-delete .image-preview-img {
        filter: grayscale(100%);
    }
  </style>
</th:block>

<body>
<th:block layout:fragment="content">
  <!-- ê²Œì‹œê¸€ ìˆ˜ì • í—¤ë” -->
  <div class="write-post-header">
    <div class="back-button" id="backButton">
      <i class="fas fa-arrow-left"></i>
      <span>ë’¤ë¡œ ê°€ê¸°</span>
    </div>
    <h2 class="write-post-title">ê²Œì‹œê¸€ ìˆ˜ì •</h2>
    <div style="width: 80px;"></div>
  </div>

  <!-- ê²Œì‹œê¸€ ìˆ˜ì • í¼ -->
  <div class="post-form-container">
    <form th:action="@{/post/modify}" th:method="post" id="postForm" enctype="multipart/form-data">
      <!-- ì•ˆì „í•œ í•„ë“œ ì°¸ì¡°ë¡œ ìˆ˜ì • -->
      <input type="hidden" name="id" th:value="${dto?.id}">

      <!-- í˜ì´ì§• ì •ë³´ ìœ ì§€ -->
      <input type="hidden" name="page" th:value="${requestDTO?.page}">
      <input type="hidden" name="type" th:value="${requestDTO?.type}">
      <input type="hidden" name="keyword" th:value="${requestDTO?.keyword}">

      <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ (ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •) -->
      <div class="form-group">
        <label class="form-label">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
        <div class="category-select">
          <div class="category-option active" data-category="post">
            <i class="fas fa-pen-nib"></i>
            <span>ì¼ë°˜ í¬ìŠ¤íŠ¸</span>
          </div>
          <div class="category-option" data-category="companion">
            <i class="fas fa-user-friends"></i>
            <span>ë™í–‰</span>
          </div>
          <div class="category-option" data-category="route">
            <i class="fas fa-route"></i>
            <span>ì¶”ì²œ ì—¬í–‰ê²½ë¡œ</span>
          </div>
          <div class="category-option" data-category="review">
            <i class="fas fa-star"></i>
            <span>ë¦¬ë·°</span>
          </div>
        </div>
      </div>

      <!-- ì œëª© ì…ë ¥ -->
      <div class="form-group">
        <label class="form-label" for="postTitle">ì œëª©</label>
        <input type="text" id="postTitle" name="title" class="form-control" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
               maxlength="100" th:value="${dto?.title}">
        <div class="character-count"><span id="titleCount" th:text="${#strings.length(dto?.title ?: '')}">0</span>/100</div>
        <div class="form-error" id="titleError">ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
      </div>

      <!-- íƒœê·¸ ì…ë ¥ -->
      <div class="form-group">
        <label class="form-label">íƒœê·¸</label>
        <div class="tags-input-container" id="tagsContainer">
          <th:block th:if="${dto?.tags != null}">
            <div th:each="tag : ${dto.tags}"
                 class="tag"
                 th:data-tag="${tag}"
                 th:text="${tag.startsWith('#') ? tag : '#' + tag}">
              <div class="tag-close"><i class="fas fa-times"></i></div>
            </div>
          </th:block>
          <input type="text" class="tag-input" id="tagInput" placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  Enter í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”">
        </div>
        <span class="form-hint">ìµœëŒ€ 5ê°œê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê° íƒœê·¸ëŠ” '#'ìœ¼ë¡œ ì‹œì‘í•˜ë©° 15ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.</span>
        <div class="form-error" id="tagsError">íƒœê·¸ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
      </div>

      <!-- ë‚´ìš© ì…ë ¥ -->
      <div class="form-group">
        <label class="form-label" for="postContent">ë‚´ìš©</label>
        <textarea id="postContent" name="content" class="form-control form-textarea"
                  placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" maxlength="3000" required th:text="${dto?.content}"></textarea>
        <div class="character-count"><span id="contentCount" th:text="${#strings.length(dto?.content ?: '')}">0</span>/3000</div>
        <div class="form-error" id="contentError">ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
      </div>

      <!-- ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ ë° ì‚­ì œ ì„ íƒ -->
      <div class="form-group" th:if="${dto?.imageUrls != null and !dto.imageUrls.isEmpty()}">
        <label class="form-label">ê¸°ì¡´ ì´ë¯¸ì§€</label>
        <span class="form-hint">ì‚­ì œí•  ì´ë¯¸ì§€ë¥¼ ì²´í¬í•˜ì„¸ìš”</span>
        <div class="existing-images">
          <div th:each="imageUrl, stat : ${dto.imageUrls}" class="existing-image-item">
            <input type="checkbox"
                   class="existing-image-checkbox delete-image-checkbox"
                   th:id="'deleteImage' + ${stat.index}"
                   th:value="${stat.index}"
                   name="deleteImageIndexes">
            <label th:for="'deleteImage' + ${stat.index}" class="existing-image-label">ì‚­ì œ</label>
            <img th:src="${imageUrl}" class="image-preview-img" alt="ê¸°ì¡´ ì´ë¯¸ì§€">
          </div>
        </div>
      </div>

      <!-- ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
      <div class="form-group">
        <label class="form-label">ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€</label>
        <span class="form-hint">ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (jpg, png, gif í˜•ì‹, ê° 5MB ì´í•˜)</span>
        <div class="image-upload-container">
          <div class="image-preview-area" id="imagePreviewArea">
            <label for="imageUpload" class="image-upload-btn">
              <i class="fas fa-plus"></i>
              <span>ì´ë¯¸ì§€ ì¶”ê°€</span>
            </label>
          </div>
          <input type="file" id="imageUpload" name="imageFiles" accept="image/jpeg, image/png, image/gif" style="display: none;"
                 multiple>
        </div>
        <div class="form-error" id="imageError">ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
      </div>

      <!-- ìœ„ì¹˜ ì •ë³´ -->
      <div class="form-group">
        <label class="form-label">ìœ„ì¹˜ ì •ë³´ (ì„ íƒ)</label>
        <div class="location-search-container">
          <div class="location-search-box">
            <input type="text" id="locationSearch" class="location-search-input"
                   placeholder="ì „ì„¸ê³„ ê²€ìƒ‰: Paris, New York, Tokyo, London, Dubai ë“±"
                   th:value="${dto?.placeName}">
            <button type="button" id="searchLocationBtn" class="location-search-btn">ê²€ìƒ‰</button>
          </div>
          <!-- ê²€ìƒ‰ ê²°ê³¼ ë“œë¡­ë‹¤ìš´ -->
          <div class="location-dropdown" id="locationDropdown">
            <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
          </div>
          <!-- ìœ„ì¹˜ ë¯¸ë¦¬ë³´ê¸° -->
          <div class="location-preview" id="locationPreview" th:style="${dto?.placeName != null} ? 'display: block;' : 'display: none;'">
            <img src="/api/placeholder/500/200" alt="ìœ„ì¹˜ ì§€ë„" class="location-preview-map">
            <div class="location-preview-info">
              <div class="location-preview-name" th:text="${dto?.placeName ?: 'ì¥ì†Œëª…'}">ì¥ì†Œëª…</div>
              <div class="location-preview-address" th:text="${dto?.placeAddress ?: 'ì£¼ì†Œ ì •ë³´'}">ì£¼ì†Œ ì •ë³´</div>
            </div>
            <div class="location-preview-remove" id="removeLocation">
              <i class="fas fa-times"></i>
            </div>
          </div>
        </div>

        <!-- ê¸°ì¡´ ìœ„ì¹˜ ì •ë³´ë¥¼ hidden í•„ë“œë¡œ ìœ ì§€ -->
        <input type="hidden" id="hiddenPlaceId" name="placeId" th:value="${dto?.placeId}">
        <input type="hidden" id="hiddenPlaceName" name="placeName" th:value="${dto?.placeName}">
        <input type="hidden" id="hiddenPlaceAddress" name="placeAddress" th:value="${dto?.placeAddress}">
      </div>

      <!-- í¼ ì•¡ì…˜ ë²„íŠ¼ -->
      <div class="form-actions">
        <button type="button" id="cancelBtn" class="cancel-btn">ì·¨ì†Œ</button>
        <button type="submit" id="submitBtn" class="submit-btn">ìˆ˜ì •í•˜ê¸°</button>
      </div>

    </form>
  </div>

  <script>
    // Google Maps API ê´€ë ¨ ë³€ìˆ˜ë“¤
    let map;
    let service;
    let geocoder;
    let currentSelectedIndex = -1;
    let isGoogleMapsInitialized = false;

    // ìƒˆë¡œìš´ ë°©ì‹: ì‹¤ì œ íŒŒì¼ë“¤ì„ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
    let allSelectedFiles = [];

    // Google Maps API ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë¨¼ì € ì •ì˜
    window.initLocationSearch = function() {
        console.log('ğŸš€ Google Maps API ì´ˆê¸°í™” ì‹œì‘');
        try {
            const mapDiv = document.createElement('div');
            mapDiv.style.display = 'none';
            document.body.appendChild(mapDiv);

            map = new google.maps.Map(mapDiv, {
                center: { lat: 0, lng: 0 },
                zoom: 1
            });

            service = new google.maps.places.PlacesService(map);
            geocoder = new google.maps.Geocoder();
            isGoogleMapsInitialized = true;

            console.log('âœ… Google Maps API ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
            console.error('âŒ Google Maps API ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            isGoogleMapsInitialized = false;
        }
    };

    // ì§€ì—° ì´ˆê¸°í™” í•¨ìˆ˜
    function initializeGoogleMapsOnDemand() {
        return new Promise((resolve, reject) => {
            if (isGoogleMapsInitialized && service && geocoder) {
                resolve();
                return;
            }

            if (!window.google || !window.google.maps) {
                reject(new Error('Google Maps APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'));
                return;
            }

            try {
                const mapDiv = document.createElement('div');
                mapDiv.style.display = 'none';
                document.body.appendChild(mapDiv);

                map = new google.maps.Map(mapDiv, {
                    center: { lat: 0, lng: 0 },
                    zoom: 1
                });

                service = new google.maps.places.PlacesService(map);
                geocoder = new google.maps.Geocoder();
                isGoogleMapsInitialized = true;

                console.log('âœ… ì§€ì—° ì´ˆê¸°í™” ì™„ë£Œ');
                resolve();
            } catch (error) {
                console.error('âŒ ì§€ì—° ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                isGoogleMapsInitialized = false;
                reject(error);
            }
        });
    }

    $(document).ready(function () {
        console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ, ìˆ˜ì • í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

        if (!$('#postTitle').length) {
            console.error('í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }

        // ê¸°ì¡´ ìœ„ì¹˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ì§€ë„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
        const existingPlaceName = $('#hiddenPlaceName').val();
        const existingPlaceAddress = $('#hiddenPlaceAddress').val();
        if (existingPlaceName && existingPlaceAddress) {
            updateLocationMapByAddress(existingPlaceAddress);
        }

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ
        $('.category-option').click(function () {
            $('.category-option').removeClass('active');
            $(this).addClass('active');
        });

        // ì œëª© ê¸€ììˆ˜ ì¹´ìš´íŠ¸
        $('#postTitle').on('input', function () {
            const length = $(this).val().length;
            $('#titleCount').text(length);

            if (length > 0) {
                $('#titleError').hide();
            }
        });

        // ë‚´ìš© ê¸€ììˆ˜ ì¹´ìš´íŠ¸
        $('#postContent').on('input', function () {
            const length = $(this).val().length;
            $('#contentCount').text(length);

            if (length > 0) {
                $('#contentError').hide();
            }
        });

        // ê¸°ì¡´ íƒœê·¸ë“¤ì— ì‚­ì œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        $('.tag .tag-close').click(function () {
            $(this).parent().remove();
            $('#tagsError').hide();
        });

        // íƒœê·¸ ì…ë ¥ ì²˜ë¦¬
        $('#tagInput').on('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();

                const tagText = $(this).val().trim();
                if (!tagText) return;

                let tagName = tagText;

                // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸ì¸ì§€ í™•ì¸
                let tagExists = false;
                $('.tag').each(function () {
                    if ($(this).data('tag') === tagName) {
                        tagExists = true;
                        return false;
                    }
                });

                if (tagExists) {
                    showToast('ì´ë¯¸ ì¶”ê°€ëœ íƒœê·¸ì…ë‹ˆë‹¤');
                    $(this).val('');
                    return;
                }

                // íƒœê·¸ ê°œìˆ˜ ì œí•œ í™•ì¸
                if ($('.tag').length >= 5) {
                    $('#tagsError').text('íƒœê·¸ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤').show();
                    return;
                }

                // íƒœê·¸ ê¸¸ì´ ì œí•œ í™•ì¸
                if (tagName.length > 15) {
                    $('#tagsError').text('íƒœê·¸ëŠ” 15ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”').show();
                    return;
                }

                // ìƒˆ íƒœê·¸ ì¶”ê°€
                const displayTag = tagName.startsWith('#') ? tagName : '#' + tagName;
                const newTag = $('<div class="tag" data-tag="' + tagName + '">' + displayTag + '<div class="tag-close"><i class="fas fa-times"></i></div></div>');
                $(this).before(newTag);
                $(this).val('');
                $('#tagsError').hide();

                // íƒœê·¸ ì‚­ì œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                newTag.find('.tag-close').click(function () {
                    $(this).parent().remove();
                    $('#tagsError').hide();
                });
            }
        });

        // ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
        $('.delete-image-checkbox').change(function() {
            const imageItem = $(this).closest('.existing-image-item');
            if ($(this).is(':checked')) {
                imageItem.addClass('to-delete');
            } else {
                imageItem.removeClass('to-delete');
            }
        });

        // ìƒˆë¡œìš´ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        $('#imageUpload').change(function (e) {
            const newFiles = Array.from(e.target.files);
            console.log("ìƒˆë¡œ ì„ íƒëœ íŒŒì¼ ìˆ˜:", newFiles.length);

            allSelectedFiles = [...allSelectedFiles, ...newFiles];

            // ê¸°ì¡´ ì´ë¯¸ì§€ ê°œìˆ˜ í™•ì¸
            const existingImageCount = $('.existing-image-item').length;
            const checkedForDeletionCount = $('.delete-image-checkbox:checked').length;
            const remainingExistingImages = existingImageCount - checkedForDeletionCount;
            const totalImages = remainingExistingImages + allSelectedFiles.length;

            if (totalImages > 5) {
                $('#imageError').text('ì „ì²´ ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 5ì¥ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤').show();
                allSelectedFiles = allSelectedFiles.slice(0, 5 - remainingExistingImages);
            } else {
                $('#imageError').hide();
            }

            // ìœ íš¨í•œ íŒŒì¼ë“¤ë§Œ í•„í„°ë§
            const validFiles = [];
            allSelectedFiles.forEach((file, index) => {
                if (!file.type.match('image/jpeg') && !file.type.match('image/png') && !file.type.match('image/gif')) {
                    showToast('JPG, PNG, GIF í˜•ì‹ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB
                    showToast('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                    return;
                }

                validFiles.push(file);
            });

            allSelectedFiles = validFiles;
            redrawAllPreviews();
            updateHiddenFileInputs();
            $(this).val('');
        });

        // ëª¨ë“  ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
        function redrawAllPreviews() {
            $('.image-preview-item').not(':has(.image-upload-btn)').remove();
            allSelectedFiles.forEach((file, index) => {
                createSimpleImagePreview(file, index);
            });
        }

        // ê°„ë‹¨í•œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
        function createSimpleImagePreview(file, index) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const imagePreview = $(`
                    <div class="image-preview-item" data-file-index="${index}">
                        <img src="${e.target.result}" class="image-preview-img" alt="ë¯¸ë¦¬ë³´ê¸°">
                        <div class="image-preview-remove" onclick="removeFileAtIndex(${index})">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="image-file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                `);
                imagePreview.insertBefore($('.image-upload-btn').parent());
            };
            reader.readAsDataURL(file);
        }

        // ì‹¤ì œ íŒŒì¼ë“¤ì„ ìˆ¨ê²¨ì§„ inputë“¤ë¡œ ì „ì†¡
        function updateHiddenFileInputs() {
            $('.hidden-file-input').remove();
            allSelectedFiles.forEach((file, index) => {
                const fileInput = $('<input>', {
                    type: 'file',
                    name: 'imageFiles',
                    class: 'hidden-file-input',
                    style: 'display: none;'
                });

                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput[0].files = dataTransfer.files;
                $('#postForm').append(fileInput);
            });
        }

        // ìœ„ì¹˜ ê²€ìƒ‰ í•¨ìˆ˜
        async function performLocationSearch(query) {
            showLocationDropdown(['<div class="location-search-loading"><i class="fas fa-spinner fa-spin"></i> ì§€ë„ ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì¤‘...</div>']);

            try {
                await initializeGoogleMapsOnDemand();
            } catch (error) {
                showLocationDropdown(['<div class="location-search-no-results">ì§€ë„ ì„œë¹„ìŠ¤ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>']);
                return;
            }

            showLocationDropdown(['<div class="location-search-loading"><i class="fas fa-spinner fa-spin"></i> ì „ì„¸ê³„ ê²€ìƒ‰ ì¤‘...</div>']);

            const placesRequest = {
                query: query,
                fields: ['place_id', 'name', 'formatted_address', 'geometry', 'types']
            };

            service.textSearch(placesRequest, (placesResults, placesStatus) => {
                const geocodingRequest = {
                    address: query
                };

                geocoder.geocode(geocodingRequest, (geocodeResults, geocodeStatus) => {
                    let combinedResults = [];

                    if (placesStatus === google.maps.places.PlacesServiceStatus.OK && placesResults) {
                        combinedResults = [...placesResults];
                    }

                    if (geocodeStatus === 'OK' && geocodeResults) {
                        geocodeResults.forEach(result => {
                            const isDuplicate = combinedResults.some(existing =>
                                existing.formatted_address === result.formatted_address ||
                                existing.place_id === result.place_id
                            );

                            if (!isDuplicate) {
                                const convertedResult = {
                                    place_id: result.place_id,
                                    name: extractLocationName(result.formatted_address),
                                    formatted_address: result.formatted_address,
                                    geometry: result.geometry,
                                    types: result.types || []
                                };
                                combinedResults.push(convertedResult);
                            }
                        });
                    }

                    if (combinedResults.length > 0) {
                        displayLocationResults(combinedResults);
                    } else {
                        showLocationDropdown([
                            '<div class="location-search-no-results">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>' +
                            'ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”. (ì˜ˆ: "Paris France", "New York USA")</div>'
                        ]);
                    }
                });
            });
        }

        function extractLocationName(address) {
            if (!address) return 'ì¥ì†Œëª… ì—†ìŒ';
            const parts = address.split(',');
            return parts[0].trim();
        }

        function displayLocationResults(results) {
            let resultsHtml = [];

            results.forEach((place, index) => {
                const placeName = place.name || 'ì¥ì†Œëª… ì—†ìŒ';
                const placeAddress = place.formatted_address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';

                let placeType = '';
                if (place.types && place.types.length > 0) {
                    const typeMap = {
                        'locality': 'ë„ì‹œ',
                        'country': 'êµ­ê°€',
                        'administrative_area_level_1': 'ì£¼/ë„',
                        'tourist_attraction': 'ê´€ê´‘ì§€',
                        'restaurant': 'ë ˆìŠ¤í† ë‘',
                        'lodging': 'ìˆ™ë°•ì‹œì„¤',
                        'airport': 'ê³µí•­',
                        'train_station': 'ê¸°ì°¨ì—­',
                        'shopping_mall': 'ì‡¼í•‘ëª°'
                    };

                    for (let type of place.types) {
                        if (typeMap[type]) {
                            placeType = typeMap[type];
                            break;
                        }
                    }
                }

                const resultHtml = `
                    <div class="location-dropdown-item" data-index="${index}"
                         data-place-id="${place.place_id}"
                         data-place-name="${placeName}"
                         data-place-address="${placeAddress}">
                        <div class="location-name">${placeName}</div>
                        <div class="location-address">${placeAddress}</div>
                        ${placeType ? `<div class="location-type">${placeType}</div>` : ''}
                    </div>
                `;
                resultsHtml.push(resultHtml);
            });

            showLocationDropdown(resultsHtml);
            currentSelectedIndex = -1;
        }

        function showLocationDropdown(htmlArray) {
            const dropdown = $('#locationDropdown');
            const searchContainer = $('.location-search-container');

            dropdown.html(htmlArray.join(''));
            dropdown.removeClass('dropup');
            dropdown.addClass('show');

            setTimeout(() => {
                const dropdownHeight = dropdown.outerHeight();
                const containerOffset = searchContainer.offset();
                const containerHeight = searchContainer.outerHeight();
                const windowHeight = $(window).height();
                const scrollTop = $(window).scrollTop();

                const spaceBelow = windowHeight + scrollTop - (containerOffset.top + containerHeight);
                const spaceAbove = containerOffset.top - scrollTop;

                if (dropdownHeight > spaceBelow && spaceAbove > spaceBelow && spaceAbove > 200) {
                    dropdown.addClass('dropup');
                }
            }, 10);
        }

        function hideLocationDropdown() {
            const dropdown = $('#locationDropdown');
            dropdown.removeClass('show dropup');
            currentSelectedIndex = -1;
        }

        function updateSelectedItem(items) {
            items.removeClass('active');
            if (currentSelectedIndex >= 0) {
                $(items[currentSelectedIndex]).addClass('active');
            }
        }

        // ìœ„ì¹˜ ê²€ìƒ‰ ì…ë ¥ ì²˜ë¦¬
        $('#locationSearch').on('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = $(this).val().trim();
                if (query) {
                    performLocationSearch(query);
                }
            }

            const dropdown = $('#locationDropdown');
            const items = dropdown.find('.location-dropdown-item');

            if (!dropdown.hasClass('show') || items.length === 0) return;

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    currentSelectedIndex = Math.min(currentSelectedIndex + 1, items.length - 1);
                    updateSelectedItem(items);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    currentSelectedIndex = Math.max(currentSelectedIndex - 1, -1);
                    updateSelectedItem(items);
                    break;
                case 'Escape':
                    hideLocationDropdown();
                    break;
            }
        });

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        $('#searchLocationBtn').click(function () {
            const query = $('#locationSearch').val().trim();
            if (query) {
                performLocationSearch(query);
            } else {
                showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            }
        });

        // ìœ„ì¹˜ ì„ íƒ ì²˜ë¦¬
        $(document).on('click', '.location-dropdown-item', function () {
            const placeId = $(this).data('place-id');
            const placeName = $(this).data('place-name');
            const placeAddress = $(this).data('place-address');

            $('#locationSearch').val(placeName);
            $('#locationPreview').find('.location-preview-name').text(placeName);
            $('#locationPreview').find('.location-preview-address').text(placeAddress);

            if (placeId && service) {
                getPlaceDetailsAndUpdateMap(placeId, placeName);
            } else {
                updateLocationMapByAddress(placeAddress);
            }

            $('#locationPreview').show();
            hideLocationDropdown();

            $('#hiddenPlaceId').val(placeId || '');
            $('#hiddenPlaceName').val(placeName);
            $('#hiddenPlaceAddress').val(placeAddress);
        });

        function getPlaceDetailsAndUpdateMap(placeId, placeName) {
            const request = {
                placeId: placeId,
                fields: ['geometry', 'name', 'formatted_address']
            };

            service.getDetails(request, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && place.geometry && place.geometry.location) {
                    const lat = place.geometry.location.lat();
                    const lng = place.geometry.location.lng();
                    updateLocationMapByCoordinates(lat, lng, placeName);
                } else {
                    updateLocationMapByPlaceId(placeId, placeName);
                }
            });
        }

        function updateLocationMapByCoordinates(lat, lng, placeName) {
            const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?` +
                `center=${lat},${lng}&` +
                `zoom=15&` +
                `size=500x200&` +
                `markers=color:red%7C${lat},${lng}&` +
                `key=AIzaSyBxNabOta7u8Pj4FJuD0rdAKeGfOOEPrcE`;

            $('#locationPreview').find('.location-preview-map').attr('src', mapUrl);
        }

        function updateLocationMapByPlaceId(placeId, placeName) {
            const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?` +
                `center=place_id:${placeId}&` +
                `zoom=15&` +
                `size=500x200&` +
                `markers=color:red%7Cplace_id:${placeId}&` +
                `key=AIzaSyBxNabOta7u8Pj4FJuD0rdAKeGfOOEPrcE`;

            $('#locationPreview').find('.location-preview-map').attr('src', mapUrl);
        }

        function updateLocationMapByAddress(address) {
            const encodedAddress = encodeURIComponent(address);
            const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?` +
                `center=${encodedAddress}&` +
                `zoom=15&` +
                `size=500x200&` +
                `markers=color:red%7C${encodedAddress}&` +
                `key=AIzaSyBxNabOta7u8Pj4FJuD0rdAKeGfOOEPrcE`;

            $('#locationPreview').find('.location-preview-map').attr('src', mapUrl);
        }

        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆì‹œ ë“œë¡­ë‹¤ìš´ ìœ„ì¹˜ ì¬ê³„ì‚°
        $(window).on('resize scroll', function() {
            const dropdown = $('#locationDropdown');
            if (dropdown.hasClass('show')) {
                const htmlContent = dropdown.html();
                dropdown.removeClass('show dropup');
                setTimeout(() => {
                    showLocationDropdown([htmlContent]);
                }, 10);
            }
        });

        // ë¬¸ì„œ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
        $(document).click(function (e) {
            if (!$(e.target).closest('.location-search-container').length) {
                hideLocationDropdown();
            }
        });

        // ìœ„ì¹˜ ì‚­ì œ
        $('#removeLocation').click(function () {
            $('#locationPreview').hide();
            $('#locationSearch').val('');
            $('#hiddenPlaceId').val('');
            $('#hiddenPlaceName').val('');
            $('#hiddenPlaceAddress').val('');
        });

        // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
        $('#backButton').click(function () {
            window.history.back();
        });

        // ì·¨ì†Œ ë²„íŠ¼
        $('#cancelBtn').click(function () {
            window.history.back();
        });

        // í¼ ì œì¶œ ì²˜ë¦¬
        $('#postForm').submit(function (e) {
            e.preventDefault();

            let isValid = true;

            const title = $('#postTitle').val().trim();
            if (!title) {
                $('#titleError').show();
                isValid = false;
            }

            const content = $('#postContent').val().trim();
            if (!content) {
                $('#contentError').show();
                isValid = false;
            }

            if (isValid) {
                console.log("=== ìˆ˜ì • í¼ ì œì¶œ ì „ ìµœì¢… í™•ì¸ ===");
                console.log("ìƒˆ ì´ë¯¸ì§€ íŒŒì¼ ìˆ˜:", allSelectedFiles.length);
                console.log("ì‚­ì œí•  ê¸°ì¡´ ì´ë¯¸ì§€:", $('.delete-image-checkbox:checked').length + "ê°œ");

                // íƒœê·¸ ì²˜ë¦¬
                $('input[name="tags"]').remove();
                $('.tag').each(function () {
                    const tagValue = $(this).data('tag');
                    $('#postForm').append('<input type="hidden" name="tags" value="' + tagValue + '">');
                });

                // ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬
                const category = $('.category-option.active').data('category');
                $('#hiddenCategory').remove();
                $('#postForm').append('<input type="hidden" id="hiddenCategory" name="category" value="' + category + '">');

                // ì‹¤ì œ í¼ ì œì¶œ
                this.submit();
            } else {
                const firstError = $('.form-error:visible').first();
                if (firstError.length) {
                    $('html, body').animate({
                        scrollTop: firstError.offset().top - 100
                    }, 500);
                }
            }
        });

        function showToast(message) {
            alert(message);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    });

    // ì „ì—­ í•¨ìˆ˜: íŠ¹ì • ì¸ë±ìŠ¤ì˜ íŒŒì¼ ì œê±°
    function removeFileAtIndex(index) {
        console.log("íŒŒì¼ ì œê±°:", index);
        allSelectedFiles.splice(index, 1);
        redrawAllPreviews();
        updateHiddenFileInputs();
        $('#imageError').hide();
    }

    function redrawAllPreviews() {
        $('.image-preview-item').not(':has(.image-upload-btn)').remove();
        allSelectedFiles.forEach((file, index) => {
            createSimpleImagePreview(file, index);
        });
    }

    function createSimpleImagePreview(file, index) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const imagePreview = $(`
                <div class="image-preview-item" data-file-index="${index}">
                    <img src="${e.target.result}" class="image-preview-img" alt="ë¯¸ë¦¬ë³´ê¸°">
                    <div class="image-preview-remove" onclick="removeFileAtIndex(${index})">
                        <i class="fas fa-times"></i>
                    </div>
                    <div class="image-file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                </div>
            `);
            imagePreview.insertBefore($('.image-upload-btn').parent());
        };
        reader.readAsDataURL(file);
    }

    function updateHiddenFileInputs() {
        $('.hidden-file-input').remove();
        allSelectedFiles.forEach((file, index) => {
            const fileInput = $('<input>', {
                type: 'file',
                name: 'imageFiles',
                class: 'hidden-file-input',
                style: 'display: none;'
            });

            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput[0].files = dataTransfer.files;
            $('#postForm').append(fileInput);
        });
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</th:block>
</body>
</html>