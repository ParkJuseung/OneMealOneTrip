<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<th:block layout:fragment="style">
  <link rel="stylesheet" th:href="@{/css/post-create.css}">

  <!-- Google Maps JavaScript API 추가 (Geocoding API도 포함) -->
  <script th:src="@{'https://maps.googleapis.com/maps/api/js'(key=${apiKey}, libraries='places', callback='initLocationSearch', loading='async')}"
          async defer></script>

  <style>

    /* 개선된 이미지 업로드 컨테이너 */
    .image-upload-container {
      width: 100% !important;
    }

    /* 이미지 미리보기 영역 스타일 */
    .image-preview-area {
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: wrap !important;
      gap: 12px !important;
      align-items: flex-start !important;
      min-height: 120px !important;
      padding: 12px !important;
      border: 2px dashed #e2e8f0 !important;
      border-radius: 12px !important;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%) !important;
      transition: all 0.3s ease !important;
    }

    .image-preview-area:hover {
      border-color: #0ED8D5 !important;
      background: linear-gradient(135deg, #f0fffe 0%, #ffffff 100%) !important;
    }

    /* 이미지 미리보기 아이템 스타일 */
    .image-preview-item {
      position: relative !important;
      width: 90px !important;
      height: 90px !important;
      margin: 0 !important;
      border-radius: 8px !important;
      overflow: hidden !important;
      flex: 0 0 auto !important;
      background: white !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    .image-preview-item:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 25px rgba(14, 216, 213, 0.15) !important;
    }

    /* 이미지 자체 스타일 */
    .image-preview-img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      transition: transform 0.3s ease !important;
    }

    .image-preview-item:hover .image-preview-img {
      transform: scale(1.03) !important;
    }

    /* 파일 정보 스타일 */
    .image-file-info {
      position: absolute !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      background: linear-gradient(to top, rgba(0,0,0,0.75), rgba(0,0,0,0.3), transparent) !important;
      color: white !important;
      padding: 12px 8px 6px !important;
      border-radius: 0 0 10px 10px !important;
      opacity: 0 !important;
      transform: translateY(8px) !important;
      transition: all 0.3s ease !important;
    }

    .image-preview-item:hover .image-file-info {
      opacity: 1 !important;
      transform: translateY(0) !important;
    }

    .file-name {
      font-weight: 600 !important;
      margin-bottom: 2px !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      white-space: nowrap !important;
      color: white !important;
      font-size: 11px !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5) !important;
    }

    .file-size {
      opacity: 0.9 !important;
      font-size: 9px !important;
      color: #e8f4fd !important;
      font-weight: 500 !important;
    }

    /* 삭제 버튼 스타일 */
    .image-preview-remove {
      position: absolute !important;
      top: 6px !important;
      right: 6px !important;
      width: 22px !important;
      height: 22px !important;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52) !important;
      color: white !important;
      border-radius: 50% !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      cursor: pointer !important;
      z-index: 10 !important;
      font-size: 10px !important;
      opacity: 0 !important;
      transform: scale(0.8) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3) !important;
    }

    .image-preview-item:hover .image-preview-remove {
      opacity: 1 !important;
      transform: scale(1) !important;
    }

    .image-preview-remove:hover {
      background: linear-gradient(135deg, #ff5252, #f44336) !important;
      transform: scale(1.1) !important;
      box-shadow: 0 4px 12px rgba(255, 82, 82, 0.4) !important;
    }

    /* 이미지 추가 버튼 스타일 */
    .image-upload-btn {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      justify-content: center !important;
      width: 90px !important;
      height: 90px !important;
      border: 2px dashed #0ED8D5 !important;
      border-radius: 8px !important;
      background: linear-gradient(135deg, #ffffff, #f8fffe) !important;
      color: #0ED8D5 !important;
      cursor: pointer !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      position: relative !important;
      overflow: hidden !important;
      flex-shrink: 0 !important;
    }

    .image-upload-btn::before {
      content: '' !important;
      position: absolute !important;
      top: 0 !important;
      left: -100% !important;
      width: 100% !important;
      height: 100% !important;
      background: linear-gradient(90deg, transparent, rgba(14, 216, 213, 0.1), transparent) !important;
      transition: left 0.5s ease !important;
    }

    .image-upload-btn:hover::before {
      left: 100% !important;
    }

    .image-upload-btn:hover {
      background: linear-gradient(135deg, #f0fffe, #ffffff) !important;
      border-color: #0BC5C2 !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 20px rgba(14, 216, 213, 0.2) !important;
    }

    .image-upload-btn i {
      font-size: 16px !important;
      margin-bottom: 4px !important;
      transition: transform 0.3s ease !important;
    }

    .image-upload-btn:hover i {
      transform: scale(1.1) !important;
    }

    .image-upload-btn span {
      font-size: 10px !important;
      font-weight: 600 !important;
      letter-spacing: 0.3px !important;
    }

    /* 기존 이미지 스타일 */
    .existing-images {
      margin-bottom: 20px !important;
      padding: 16px !important;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%) !important;
      border-radius: 12px !important;
      border: 1px solid #e2e8f0 !important;
    }

    .existing-image-item {
      position: relative !important;
      display: inline-block !important;
      margin-right: 12px !important;
      margin-bottom: 12px !important;
      width: 90px !important;
      height: 90px !important;
      border-radius: 8px !important;
      overflow: hidden !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
      transition: all 0.3s ease !important;
      background: white !important;
    }

    .existing-image-item:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12) !important;
    }

    .existing-image-checkbox {
      position: absolute !important;
      top: 6px !important;
      left: 6px !important;
      width: 18px !important;
      height: 18px !important;
      z-index: 10 !important;
      accent-color: #ff6b6b !important;
      cursor: pointer !important;
    }

    .existing-image-label {
      position: absolute !important;
      top: 6px !important;
      left: 28px !important;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9)) !important;
      backdrop-filter: blur(8px) !important;
      padding: 3px 8px !important;
      border-radius: 6px !important;
      font-size: 10px !important;
      font-weight: 600 !important;
      color: #ff6b6b !important;
      z-index: 10 !important;
      cursor: pointer !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      transition: all 0.2s ease !important;
    }

    .existing-image-label:hover {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52) !important;
      color: white !important;
      transform: scale(1.05) !important;
    }

    .existing-image-item.to-delete {
      opacity: 0.6 !important;
      transform: scale(0.95) !important;
    }

    .existing-image-item.to-delete .image-preview-img {
      filter: grayscale(100%) brightness(0.8) !important;
    }

    .existing-image-item.to-delete::after {
      content: '' !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: linear-gradient(45deg, transparent 40%, rgba(255, 107, 107, 0.3) 50%, transparent 60%) !important;
      pointer-events: none !important;
    }

    /* 반응형 디자인 */
    @media (max-width: 768px) {
      .image-preview-area {
        gap: 8px !important;
        padding: 10px !important;
      }

      .image-preview-item,
      .existing-image-item {
        width: 80px !important;
        height: 80px !important;
      }

      .image-upload-btn i {
        font-size: 14px !important;
      }

      .image-upload-btn span {
        font-size: 9px !important;
      }
    }

    @media (max-width: 480px) {
      .image-preview-area {
        gap: 6px !important;
        padding: 8px !important;
      }

      .image-preview-item,
      .existing-image-item {
        width: calc(50% - 3px) !important;
        height: 70px !important;
      }

      .file-name {
        font-size: 9px !important;
      }

      .file-size {
        font-size: 7px !important;
      }

      .image-upload-btn i {
        font-size: 12px !important;
      }

      .image-upload-btn span {
        font-size: 8px !important;
      }
    }

    /* 위치 검색 드롭다운 스타일 */
    .location-search-container {
      position: relative;
      width: 100%;
    }

    .location-search-box {
      display: flex;
      gap: 8px;
    }

    .location-search-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s ease;
    }

    .location-search-input:focus {
      border-color: #007bff;
    }

    .location-search-btn {
      padding: 12px 20px;
      background: #0ED8D5;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .location-search-btn:hover {
      background: #0BC5C2;
    }

    .location-search-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* 검색 결과 드롭다운 */
    .location-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .location-dropdown.dropup {
      top: auto;
      bottom: 100%;
      border-top: 1px solid #ddd;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    }

    .location-dropdown.show {
      display: block;
    }

    .location-dropdown::-webkit-scrollbar {
      width: 6px;
    }

    .location-dropdown::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .location-dropdown::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    .location-dropdown::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    .location-dropdown-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .location-dropdown-item:last-child {
      border-bottom: none;
    }

    .location-dropdown-item:hover {
      background-color: #f8f9fa;
    }

    .location-dropdown-item.active {
      background-color: #e7f3ff;
    }

    .location-name {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .location-address {
      font-size: 12px;
      color: #666;
      line-height: 1.4;
    }

    .location-type {
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }

    .location-preview {
      display: none;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 12px;
      position: relative;
    }

    .location-preview-header {
      display: flex;
      align-items: center;
      padding: 16px;
      background: white;
    }

    .location-preview-map {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .location-preview-info {
      flex: 1;
    }

    .location-preview-name {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 4px;
      font-size: 16px;
    }

    .location-preview-address {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }

    .location-preview-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .location-preview-remove:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    .location-search-loading {
      padding: 12px 16px;
      text-align: center;
      color: #666;
      font-size: 14px;
    }

    .location-search-no-results {
      padding: 12px 16px;
      text-align: center;
      color: #999;
      font-size: 14px;
    }

    .image-file-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      color: white;
      padding: 8px 6px 4px;
      border-radius: 0 0 8px 8px;
      font-size: 10px;
    }

    .file-name {
      font-weight: 500;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-size {
      opacity: 0.8;
    }

    .image-preview-item {
      position: relative;
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .image-preview-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .image-preview-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.3s ease;
    }

    .image-preview-remove:hover {
      background: rgba(255, 0, 0, 1);
    }

    /* 기존 이미지 스타일 */
    .existing-images {
      margin-bottom: 16px;
    }

    .existing-image-item {
      position: relative;
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .existing-image-checkbox {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 20px;
      height: 20px;
      z-index: 10;
    }

    .existing-image-label {
      position: absolute;
      top: 4px;
      left: 26px;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      color: #333;
      z-index: 10;
    }

    .existing-image-item.to-delete {
      opacity: 0.5;
    }

    .existing-image-item.to-delete .image-preview-img {
      filter: grayscale(100%);
    }
  </style>
</th:block>

<body>
<th:block layout:fragment="content">
  <!-- 게시글 수정 헤더 -->
  <div class="write-post-header">
    <div class="back-button" id="backButton">
      <i class="fas fa-arrow-left"></i>
      <span>뒤로 가기</span>
    </div>
    <h2 class="write-post-title">게시글 수정</h2>
    <div style="width: 80px;"></div>
  </div>

  <!-- 게시글 수정 폼 -->
  <div class="post-form-container">
    <form th:action="@{/post/modify}" th:method="post" id="postForm" enctype="multipart/form-data">
      <input type="hidden" name="id" th:value="${dto?.id}">
      <input type="hidden" name="page" th:value="${requestDTO?.page}">
      <input type="hidden" name="type" th:value="${requestDTO?.type}">
      <input type="hidden" name="keyword" th:value="${requestDTO?.keyword}">

      <!-- 카테고리 선택 -->
      <div class="form-group">
        <label class="form-label">카테고리 선택</label>
        <div class="category-select">
          <div class="category-option active" data-category="post">
            <i class="fas fa-pen-nib"></i>
            <span>일반 포스트</span>
          </div>
          <div class="category-option" data-category="companion">
            <i class="fas fa-user-friends"></i>
            <span>동행</span>
          </div>
          <div class="category-option" data-category="route">
            <i class="fas fa-route"></i>
            <span>추천 여행경로</span>
          </div>
          <div class="category-option" data-category="review">
            <i class="fas fa-star"></i>
            <span>리뷰</span>
          </div>
        </div>
      </div>

      <!-- 제목 입력 -->
      <div class="form-group">
        <label class="form-label" for="postTitle">제목</label>
        <input type="text" id="postTitle" name="title" class="form-control" placeholder="제목을 입력해주세요"
               maxlength="100" th:value="${dto?.title}">
        <div class="character-count"><span id="titleCount" th:text="${#strings.length(dto?.title ?: '')}">0</span>/100</div>
        <div class="form-error" id="titleError">제목을 입력해주세요</div>
      </div>

      <!-- 태그 입력 -->
      <div class="form-group">
        <label class="form-label">태그</label>
        <div class="tags-input-container" id="tagsContainer">
          <th:block th:if="${dto?.tags != null}">
            <div th:each="tag : ${dto.tags}"
                 class="tag"
                 th:data-tag="${tag}"
                 th:text="${tag.startsWith('#') ? tag : '#' + tag}">
              <div class="tag-close"><i class="fas fa-times"></i></div>
            </div>
          </th:block>
          <input type="text" class="tag-input" id="tagInput" placeholder="태그를 입력하고 Enter 키를 누르세요">
        </div>
        <span class="form-hint">최대 5개까지 입력 가능합니다. 각 태그는 '#'으로 시작하며 15자 이하로 작성해주세요.</span>
        <div class="form-error" id="tagsError">태그는 최대 5개까지 입력 가능합니다</div>
      </div>

      <!-- 내용 입력 -->
      <div class="form-group">
        <label class="form-label" for="postContent">내용</label>
        <textarea id="postContent" name="content" class="form-control form-textarea"
                  placeholder="내용을 입력해주세요" maxlength="3000" required th:text="${dto?.content}"></textarea>
        <div class="character-count"><span id="contentCount" th:text="${#strings.length(dto?.content ?: '')}">0</span>/3000</div>
        <div class="form-error" id="contentError">내용을 입력해주세요</div>
      </div>

      <!-- 기존 이미지 표시 및 삭제 선택 -->
      <div class="form-group" th:if="${dto?.imageUrls != null and !dto.imageUrls.isEmpty()}">
        <label class="form-label">기존 이미지</label>
        <span class="form-hint">삭제할 이미지를 체크하세요</span>
        <div class="existing-images">
          <div th:each="imageUrl, stat : ${dto.imageUrls}" class="existing-image-item">
            <input type="checkbox"
                   class="existing-image-checkbox delete-image-checkbox"
                   th:id="'deleteImage' + ${stat.index}"
                   th:value="${stat.index}"
                   name="deleteImageIndexes">
            <label th:for="'deleteImage' + ${stat.index}" class="existing-image-label">삭제</label>
            <img th:src="${imageUrl}" class="image-preview-img" alt="기존 이미지">
          </div>
        </div>
      </div>

      <!-- 새 이미지 업로드 -->
      <div class="form-group">
        <label class="form-label">새 이미지 추가</label>
        <span class="form-hint">최대 5장까지 업로드 가능합니다. (jpg, png, gif 형식, 각 5MB 이하)</span>
        <div class="image-upload-container">
          <div class="image-preview-area" id="imagePreviewArea">
            <label for="imageUpload" class="image-upload-btn">
              <i class="fas fa-plus"></i>
              <span>이미지 추가</span>
            </label>
          </div>
          <input type="file" id="imageUpload" name="imageFiles" accept="image/jpeg, image/png, image/gif" style="display: none;"
                 multiple>
        </div>
        <div class="form-error" id="imageError">이미지는 최대 5장까지 업로드 가능합니다</div>
      </div>

      <!-- 위치 정보 -->
      <div class="form-group">
        <label class="form-label">위치 정보 (선택)</label>
        <div class="location-search-container">
          <div class="location-search-box">
            <input type="text" id="locationSearch" class="location-search-input"
                   placeholder="전세계 검색: Paris, New York, Tokyo, London, Dubai 등"
                   th:value="${dto?.placeName}">
            <button type="button" id="searchLocationBtn" class="location-search-btn">검색</button>
          </div>
          <div class="location-dropdown" id="locationDropdown"></div>

          <div class="location-preview" id="locationPreview" th:style="${dto?.placeName != null} ? 'display: block;' : 'display: none;'">
            <img src="/api/placeholder/500/200" alt="위치 지도" class="location-preview-map">
            <div class="location-preview-header">
              <i class="fas fa-map-marker-alt" style="font-size: 24px; color: #007bff; margin-right: 12px;"></i>
              <div class="location-preview-info">
                <div class="location-preview-name" th:text="${dto?.placeName ?: '장소명'}">장소명</div>
                <div class="location-preview-address" th:text="${dto?.placeAddress ?: '주소 정보'}">주소 정보</div>
              </div>
            </div>
            <div class="location-preview-remove" id="removeLocation">
              <i class="fas fa-times"></i>
            </div>
          </div>
        </div>

        <input type="hidden" id="hiddenPlaceId" name="placeId" th:value="${dto?.placeId}">
        <input type="hidden" id="hiddenPlaceName" name="placeName" th:value="${dto?.placeName}">
        <input type="hidden" id="hiddenPlaceAddress" name="placeAddress" th:value="${dto?.placeAddress}">
      </div>

      <!-- 폼 액션 버튼 -->
      <div class="form-actions">
        <button type="button" id="cancelBtn" class="cancel-btn">취소</button>
        <button type="submit" id="submitBtn" class="submit-btn">수정하기</button>
      </div>
    </form>
  </div>

  <script>
    // 전역 변수들
    let map;
    let service;
    let geocoder;
    let currentSelectedIndex = -1;
    let isGoogleMapsInitialized = false;
    let allSelectedFiles = [];
    const apiKey = '[[${apiKey}]]';

    // Google Maps API 초기화 함수 (전역으로 정의)
    window.initLocationSearch = function() {
      try {
        const mapDiv = document.createElement('div');
        mapDiv.style.display = 'none';
        document.body.appendChild(mapDiv);

        map = new google.maps.Map(mapDiv, {
          center: { lat: 0, lng: 0 },
          zoom: 1
        });

        service = new google.maps.places.PlacesService(map);
        geocoder = new google.maps.Geocoder();
        isGoogleMapsInitialized = true;

      } catch (error) {
        isGoogleMapsInitialized = false;
      }
    };

    // 지연 초기화 함수
    function initializeGoogleMapsOnDemand() {
      return new Promise((resolve, reject) => {
        if (isGoogleMapsInitialized && service && geocoder) {
          resolve();
          return;
        }

        if (!window.google || !window.google.maps) {
          reject(new Error('Google Maps API가 로드되지 않았습니다'));
          return;
        }

        try {
          const mapDiv = document.createElement('div');
          mapDiv.style.display = 'none';
          document.body.appendChild(mapDiv);

          map = new google.maps.Map(mapDiv, {
            center: { lat: 0, lng: 0 },
            zoom: 1
          });

          service = new google.maps.places.PlacesService(map);
          geocoder = new google.maps.Geocoder();
          isGoogleMapsInitialized = true;


          resolve();
        } catch (error) {

          isGoogleMapsInitialized = false;
          reject(error);
        }
      });
    }

    // 도큐먼트 준비 완료 시 실행
    $(document).ready(function() {


      if (!$('#postTitle').length) {

        return;
      }

      // 기존 위치 정보가 있으면 지도 이미지 업데이트
      const existingPlaceName = $('#hiddenPlaceName').val();
      const existingPlaceAddress = $('#hiddenPlaceAddress').val();
      if (existingPlaceName && existingPlaceAddress) {
        updateLocationMapByAddress(existingPlaceAddress);
      }

      // 카테고리 선택
      $('.category-option').click(function() {
        $('.category-option').removeClass('active');
        $(this).addClass('active');
      });

      // 제목 글자수 카운트
      $('#postTitle').on('input', function() {
        const length = $(this).val().length;
        $('#titleCount').text(length);
        if (length > 0) {
          $('#titleError').hide();
        }
      });

      // 내용 글자수 카운트
      $('#postContent').on('input', function() {
        const length = $(this).val().length;
        $('#contentCount').text(length);
        if (length > 0) {
          $('#contentError').hide();
        }
      });

      // 기존 태그 삭제 이벤트 바인딩
      $('.tag .tag-close').click(function() {
        $(this).parent().remove();
        $('#tagsError').hide();
      });

      // 태그 입력 처리
      $('#tagInput').on('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();

          const tagText = $(this).val().trim();
          if (!tagText) return;

          let tagName = tagText.startsWith('#') ? tagText : '#' + tagText;

          // 이미 존재하는 태그인지 확인
          let tagExists = false;
          $('.tag').each(function() {
            if ($(this).data('tag') === tagName) {
              tagExists = true;
              return false;
            }
          });

          if (tagExists) {
            showToast('이미 추가된 태그입니다');
            $(this).val('');
            return;
          }

          // 태그 개수 제한 확인
          if ($('.tag').length >= 5) {
            $('#tagsError').text('태그는 최대 5개까지 입력 가능합니다').show();
            return;
          }

          // 태그 길이 제한 확인
          if (tagName.length > 15) {
            $('#tagsError').text('태그는 15자 이하로 작성해주세요').show();
            return;
          }

          // 새 태그 추가
          const newTag = $(`<div class="tag" data-tag="${tagName}">${tagName}<div class="tag-close"><i class="fas fa-times"></i></div></div>`);
          $(this).before(newTag);
          $(this).val('');
          $('#tagsError').hide();

          // 태그 삭제 이벤트 바인딩
          newTag.find('.tag-close').click(function() {
            $(this).parent().remove();
            $('#tagsError').hide();
          });
        }
      });

      // 기존 이미지 삭제 체크박스 처리
      $('.delete-image-checkbox').change(function() {
        const imageItem = $(this).closest('.existing-image-item');
        if ($(this).is(':checked')) {
          imageItem.addClass('to-delete');
        } else {
          imageItem.removeClass('to-delete');
        }
      });

      // 새로운 이미지 업로드 처리
      $('#imageUpload').change(function(e) {
        const newFiles = Array.from(e.target.files);


        // 파일 유효성 검사
        const validFiles = [];
        for (let file of newFiles) {
          if (!file.type.match('image/jpeg') && !file.type.match('image/png') && !file.type.match('image/gif')) {
            showToast('JPG, PNG, GIF 형식의 이미지만 업로드 가능합니다');
            continue;
          }

          if (file.size > 5 * 1024 * 1024) { // 5MB
            showToast('이미지 크기는 5MB 이하만 가능합니다');
            continue;
          }

          validFiles.push(file);
        }

        // 기존 파일에 추가
        allSelectedFiles = [...allSelectedFiles, ...validFiles];

        // 총 이미지 개수 확인
        const existingImageCount = $('.existing-image-item').length;
        const checkedForDeletionCount = $('.delete-image-checkbox:checked').length;
        const remainingExistingImages = existingImageCount - checkedForDeletionCount;
        const totalImages = remainingExistingImages + allSelectedFiles.length;

        if (totalImages > 5) {
          $('#imageError').text('전체 이미지는 최대 5장까지 가능합니다').show();
          const maxNewFiles = 5 - remainingExistingImages;
          allSelectedFiles = allSelectedFiles.slice(0, Math.max(0, maxNewFiles));
        } else {
          $('#imageError').hide();
        }

        redrawAllPreviews();
        updateHiddenFileInputs();
        $(this).val('');
      });

      // 위치 검색 입력 처리
      $('#locationSearch').on('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const query = $(this).val().trim();
          if (query) {
            performLocationSearch(query);
          }
          return;
        }

        const dropdown = $('#locationDropdown');
        const items = dropdown.find('.location-dropdown-item');

        if (!dropdown.hasClass('show') || items.length === 0) return;

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            currentSelectedIndex = Math.min(currentSelectedIndex + 1, items.length - 1);
            updateSelectedItem(items);
            break;
          case 'ArrowUp':
            e.preventDefault();
            currentSelectedIndex = Math.max(currentSelectedIndex - 1, -1);
            updateSelectedItem(items);
            break;
          case 'Escape':
            hideLocationDropdown();
            break;
        }
      });

      // 검색 버튼 클릭 처리
      $('#searchLocationBtn').click(function() {
        const query = $('#locationSearch').val().trim();
        if (query) {
          performLocationSearch(query);
        } else {
          showToast('검색어를 입력해주세요');
        }
      });

      // 위치 선택 처리
      $(document).on('click', '.location-dropdown-item', function() {
        const placeId = $(this).data('place-id');
        const placeName = $(this).data('place-name');
        const placeAddress = $(this).data('place-address');

        $('#locationSearch').val(placeName);
        $('#locationPreview').find('.location-preview-name').text(placeName);
        $('#locationPreview').find('.location-preview-address').text(placeAddress);

        if (placeId && service) {
          getPlaceDetailsAndUpdateMap(placeId, placeName);
        } else {
          updateLocationMapByAddress(placeAddress);
        }

        $('#locationPreview').show();
        hideLocationDropdown();

        $('#hiddenPlaceId').val(placeId || '');
        $('#hiddenPlaceName').val(placeName);
        $('#hiddenPlaceAddress').val(placeAddress);
      });

      // 윈도우 리사이즈시 드롭다운 위치 재계산
      $(window).on('resize scroll', function() {
        const dropdown = $('#locationDropdown');
        if (dropdown.hasClass('show')) {
          const htmlContent = dropdown.html();
          dropdown.removeClass('show dropup');
          setTimeout(() => {
            showLocationDropdown([htmlContent]);
          }, 10);
        }
      });

      // 문서 클릭시 드롭다운 숨기기
      $(document).click(function(e) {
        if (!$(e.target).closest('.location-search-container').length) {
          hideLocationDropdown();
        }
      });

      // 위치 삭제
      $('#removeLocation').click(function() {
        $('#locationPreview').hide();
        $('#locationSearch').val('');
        $('#hiddenPlaceId').val('');
        $('#hiddenPlaceName').val('');
        $('#hiddenPlaceAddress').val('');
      });

      // 뒤로가기 버튼
      $('#backButton').click(function() {
        window.history.back();
      });

      // 취소 버튼
      $('#cancelBtn').click(function() {
        window.history.back();
      });

      // 폼 제출 처리
      $('#postForm').submit(function(e) {
        e.preventDefault();

        let isValid = true;

        // 제목 검증
        const title = $('#postTitle').val().trim();
        if (!title) {
          $('#titleError').show();
          isValid = false;
        }

        // 내용 검증
        const content = $('#postContent').val().trim();
        if (!content) {
          $('#contentError').show();
          isValid = false;
        }

        if (isValid) {


          // 태그 처리
          $('input[name="tags"]').remove();
          $('.tag').each(function() {
            const tagValue = $(this).data('tag');
            $('#postForm').append('<input type="hidden" name="tags" value="' + tagValue + '">');
          });

          // 카테고리 처리
          const category = $('.category-option.active').data('category');
          $('#hiddenCategory').remove();
          $('#postForm').append('<input type="hidden" id="hiddenCategory" name="category" value="' + category + '">');

          // 실제 폼 제출
          this.submit();
        } else {
          const firstError = $('.form-error:visible').first();
          if (firstError.length) {
            $('html, body').animate({
              scrollTop: firstError.offset().top - 100
            }, 500);
          }
        }
      });
    });

    // 전역 함수들

    // 모든 미리보기를 다시 그리는 함수
    function redrawAllPreviews() {
      $('.image-preview-item').not(':has(.image-upload-btn)').remove();
      allSelectedFiles.forEach((file, index) => {
        createSimpleImagePreview(file, index);
      });
    }

    // 간단한 이미지 미리보기 생성
    function createSimpleImagePreview(file, index) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const imagePreview = $(`
          <div class="image-preview-item" data-file-index="${index}">
            <img src="${e.target.result}" class="image-preview-img" alt="미리보기">
            <div class="image-preview-remove" onclick="removeFileAtIndex(${index})">
              <i class="fas fa-times"></i>
            </div>
            <div class="image-file-info">
              <div class="file-name">${file.name}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
          </div>
        `);
        imagePreview.insertBefore($('.image-upload-btn').parent());
      };
      reader.readAsDataURL(file);
    }

    // 실제 파일들을 숨겨진 input들로 전송
    function updateHiddenFileInputs() {
      $('.hidden-file-input').remove();
      allSelectedFiles.forEach((file, index) => {
        const fileInput = $('<input>', {
          type: 'file',
          name: 'imageFiles',
          class: 'hidden-file-input',
          style: 'display: none;'
        });

        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput[0].files = dataTransfer.files;
        $('#postForm').append(fileInput);
      });
    }

    // 특정 인덱스의 파일 제거
    function removeFileAtIndex(index) {

      allSelectedFiles.splice(index, 1);
      redrawAllPreviews();
      updateHiddenFileInputs();
      $('#imageError').hide();
    }

    // 위치 검색 함수
    async function performLocationSearch(query) {
      showLocationDropdown(['<div class="location-search-loading"><i class="fas fa-spinner fa-spin"></i> 지도 서비스 초기화 중...</div>']);

      try {
        await initializeGoogleMapsOnDemand();
      } catch (error) {
        showLocationDropdown(['<div class="location-search-no-results">지도 서비스 초기화에 실패했습니다.<br>페이지를 새로고침하고 다시 시도해주세요.</div>']);
        return;
      }

      showLocationDropdown(['<div class="location-search-loading"><i class="fas fa-spinner fa-spin"></i> 전세계 검색 중...</div>']);

      const placesRequest = {
        query: query,
        fields: ['place_id', 'name', 'formatted_address', 'geometry', 'types']
      };

      service.textSearch(placesRequest, (placesResults, placesStatus) => {
        const geocodingRequest = {
          address: query
        };

        geocoder.geocode(geocodingRequest, (geocodeResults, geocodeStatus) => {
          let combinedResults = [];

          if (placesStatus === google.maps.places.PlacesServiceStatus.OK && placesResults) {
            combinedResults = [...placesResults];
          }

          if (geocodeStatus === 'OK' && geocodeResults) {
            geocodeResults.forEach(result => {
              const isDuplicate = combinedResults.some(existing =>
                      existing.formatted_address === result.formatted_address ||
                      existing.place_id === result.place_id
              );

              if (!isDuplicate) {
                const convertedResult = {
                  place_id: result.place_id,
                  name: extractLocationName(result.formatted_address),
                  formatted_address: result.formatted_address,
                  geometry: result.geometry,
                  types: result.types || []
                };
                combinedResults.push(convertedResult);
              }
            });
          }

          if (combinedResults.length > 0) {
            displayLocationResults(combinedResults);
          } else {
            showLocationDropdown([
              '<div class="location-search-no-results">검색 결과를 찾을 수 없습니다.<br>' +
              '다른 검색어를 시도해보세요. (예: "Paris France", "New York USA")</div>'
            ]);
          }
        });
      });
    }

    function extractLocationName(address) {
      if (!address) return '장소명 없음';
      const parts = address.split(',');
      return parts[0].trim();
    }

    function displayLocationResults(results) {
      let resultsHtml = [];

      results.forEach((place, index) => {
        const placeName = place.name || '장소명 없음';
        const placeAddress = place.formatted_address || '주소 정보 없음';

        let placeType = '';
        if (place.types && place.types.length > 0) {
          const typeMap = {
            'locality': '도시',
            'country': '국가',
            'administrative_area_level_1': '주/도',
            'tourist_attraction': '관광지',
            'restaurant': '레스토랑',
            'lodging': '숙박시설',
            'airport': '공항',
            'train_station': '기차역',
            'shopping_mall': '쇼핑몰'
          };

          for (let type of place.types) {
            if (typeMap[type]) {
              placeType = typeMap[type];
              break;
            }
          }
        }

        const resultHtml = `
          <div class="location-dropdown-item" data-index="${index}"
               data-place-id="${place.place_id}"
               data-place-name="${placeName}"
               data-place-address="${placeAddress}">
            <div class="location-name">${placeName}</div>
            <div class="location-address">${placeAddress}</div>
            ${placeType ? `<div class="location-type">${placeType}</div>` : ''}
          </div>
        `;
        resultsHtml.push(resultHtml);
      });

      showLocationDropdown(resultsHtml);
      currentSelectedIndex = -1;
    }

    function showLocationDropdown(htmlArray) {
      const dropdown = $('#locationDropdown');
      const searchContainer = $('.location-search-container');

      dropdown.html(htmlArray.join(''));
      dropdown.removeClass('dropup');
      dropdown.addClass('show');

      setTimeout(() => {
        const dropdownHeight = dropdown.outerHeight();
        const containerOffset = searchContainer.offset();
        const containerHeight = searchContainer.outerHeight();
        const windowHeight = $(window).height();
        const scrollTop = $(window).scrollTop();

        const spaceBelow = windowHeight + scrollTop - (containerOffset.top + containerHeight);
        const spaceAbove = containerOffset.top - scrollTop;

        if (dropdownHeight > spaceBelow && spaceAbove > spaceBelow && spaceAbove > 200) {
          dropdown.addClass('dropup');
        }
      }, 10);
    }

    function hideLocationDropdown() {
      const dropdown = $('#locationDropdown');
      dropdown.removeClass('show dropup');
      currentSelectedIndex = -1;
    }

    function updateSelectedItem(items) {
      items.removeClass('active');
      if (currentSelectedIndex >= 0) {
        $(items[currentSelectedIndex]).addClass('active');
      }
    }

    function getPlaceDetailsAndUpdateMap(placeId, placeName) {
      const request = {
        placeId: placeId,
        fields: ['geometry', 'name', 'formatted_address']
      };

      service.getDetails(request, (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && place.geometry && place.geometry.location) {
          const lat = place.geometry.location.lat();
          const lng = place.geometry.location.lng();
          updateLocationMapByCoordinates(lat, lng, placeName);
        } else {
          updateLocationMapByPlaceId(placeId, placeName);
        }
      });
    }

    function updateLocationMapByCoordinates(lat, lng, placeName) {
      const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?` +
              `center=${lat},${lng}&` +
              `zoom=15&` +
              `size=500x200&` +
              `markers=color:red%7C${lat},${lng}&` +
              `key=${apiKey}`;

      $('#locationPreview').find('.location-preview-map').attr('src', mapUrl);
    }

    function updateLocationMapByPlaceId(placeId, placeName) {
      const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?` +
              `center=place_id:${placeId}&` +
              `zoom=15&` +
              `size=500x200&` +
              `markers=color:red%7Cplace_id:${placeId}&` +
              `key=${apiKey}`;

      $('#locationPreview').find('.location-preview-map').attr('src', mapUrl);
    }

    function updateLocationMapByAddress(address) {
      const encodedAddress = encodeURIComponent(address);
      const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?` +
              `center=${encodedAddress}&` +
              `zoom=15&` +
              `size=500x200&` +
              `markers=color:red%7C${encodedAddress}&` +
              `key=${apiKey}`;

      $('#locationPreview').find('.location-preview-map').attr('src', mapUrl);
    }

    function showToast(message) {
      alert(message);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</th:block>
</body>
</html>