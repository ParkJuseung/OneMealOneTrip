<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<th:block layout:fragment="style">
    <link rel="stylesheet" th:href="@{/css/post-detail.css}">
</th:block>
<body>
<th:block layout:fragment="content">

    <!-- 게시글 상세 헤더 -->
    <div class="post-detail-header">
        <div class="back-button" id="backButton">
            <i class="fas fa-arrow-left"></i>
            <span>뒤로 가기</span>
        </div>
        <div class="post-detail-actions">
            <div class="action-button like-button" id="likeButton">
                <i class="far fa-heart"></i>
                <span>좋아요</span>
            </div>
            <div class="action-button bookmark-button" id="bookmarkButton">
                <i class="far fa-bookmark"></i>
                <span>저장</span>
            </div>
            <div class="action-button">
                <i class="fas fa-share-alt"></i>
                <span>공유</span>
            </div>
        </div>
    </div>

    <!-- 게시글 상세 콘텐츠 -->
    <div class="post-detail-container" id="post-detail" th:data-post-id="${dto.id}">
        <div class="post-detail-header-info">
            <div class="category-badge">동행</div>
            <div class="post-info">
                <span>조회 [[${dto.viewCount}]]</span>
                <div class="post-info-divider"></div>
                <span th:text="${#temporals.format(dto.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
            </div>
        </div>
        <div class="post-detail-content">
            <h1 class="post-detail-title">[[${dto.title}]]</h1>
            <div class="post-detail-tags">
                <span class="post-tag" th:each="tag : ${dto.tags}" th:text="'#' + ${tag}"></span>
            </div>
            <p class="post-detail-description">
                [[${dto.content}]]
            </p>

            <!-- 이미지가 있는 경우만 표시 -->
            <div class="post-detail-images" th:if="${dto.imageUrls != null and !dto.imageUrls.isEmpty()}">
                <div class="post-detail-image" th:each="imageUrl : ${dto.imageUrls}">
                    <img th:src="${imageUrl}" alt="게시글 이미지">
                </div>
            </div>

            <!-- 위치 정보가 있는 경우만 표시 -->
            <div class="location-info" th:if="${dto.placeName != null}">
                <div class="location-header">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>위치 정보</span>
                </div>
                <div class="location-map">
                    <img src="/api/placeholder/500/200" alt="지도">
                </div>
                <div class="location-address" th:text="${dto.placeName}">
                </div>
            </div>

            <!-- 작성자 정보 -->
            <div class="post-detail-author">
                <img src="/api/placeholder/50/50" alt="작성자 프로필" class="author-avatar">
                <div class="author-info">
                    <span class="author-name">작성자</span>
                    <span class="author-bio">여행과 모험을 사랑하는 프리랜서 사진작가</span>
                </div>
                <button class="follow-button" id="followButton">팔로우</button>
            </div>
        </div>
    </div>

    <!-- 댓글 섹션 -->
    <div class="comments-section">
        <div class="comments-header">
            <div class="comments-title">댓글 <span class="comments-count">0</span></div>
            <div class="comments-sort">
                <span>최신순</span>
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>

        <!-- 댓글 입력 -->
        <div class="comment-input-container">
            <img src="/api/placeholder/40/40" alt="내 프로필" class="comment-avatar">
            <div class="comment-input-wrapper">
                <textarea class="comment-input" placeholder="댓글을 남겨보세요..." rows="3"></textarea>
                <button class="comment-submit">등록</button>
            </div>
        </div>

        <!-- 댓글 목록 -->
        <div class="comments-list">
            <!-- 댓글들이 여기에 동적으로 로드됩니다 -->
        </div>

        <div class="show-more-comments" style="display: none;">
            댓글 더보기
        </div>
    </div>

    <!-- 관련 게시글 -->
    <div class="related-posts">
        <h3 class="related-posts-header">관련 게시글</h3>
        <div class="related-posts-list">
            <!-- 관련 게시글들이 여기에 표시됩니다 -->
        </div>
    </div>

    <!-- 수정/삭제 버튼 (작성자인 경우만 표시) -->
    <div class="post-actions" th:if="${session.currentUserId == dto.userId}">
        <button class="edit-post-btn" th:onclick="|location.href='/post/edit/${dto.id}'|">수정</button>
        <button class="delete-post-btn" onclick="deletePost()">삭제</button>
    </div>

    <!-- 토스트 메시지용 컨테이너 -->
    <div id="toast" class="toast-message"></div>

    <!-- 스크립트 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script th:src="@{/js/comment.js}"></script>

    <script>
        $(document).ready(function () {
            // 임시 댓글 매니저 - 캐시 문제 해결용
            const commentManager = {
                postId: [[${dto.id}]] || 1,

                init() {
                    console.log('댓글 매니저 초기화, PostID:', this.postId);
                    this.loadComments();
                    this.bindEvents();
                },

                bindEvents() {
                    // 댓글 작성 버튼
                    $('.comment-submit').off('click').on('click', () => {
                        this.createComment();
                    });

                    // 엔터키로 댓글 작성
                    $('.comment-input').off('keypress').on('keypress', (e) => {
                        if (e.which === 13 && !e.shiftKey) {
                            e.preventDefault();
                            this.createComment();
                        }
                    });
                },

                async loadComments() {
                    try {
                        const response = await fetch(`/api/comments/post/${this.postId}?page=0&size=20`);
                        const result = await response.json();

                        console.log('API 응답:', result);

                        if (result.success && result.data && result.data.dtoList) {
                            console.log('댓글 데이터:', result.data.dtoList);
                            this.renderComments(result.data.dtoList);
                            this.updateCommentCount(result.data.totalCount || result.data.dtoList.length);
                        }
                    } catch (error) {
                        console.error('댓글 로드 실패:', error);
                    }
                },

                async createComment() {
                    const content = $('.comment-input').val().trim();
                    if (!content) {
                        this.showToast('댓글 내용을 입력해주세요.', 'warning');
                        return;
                    }

                    try {
                        console.log('댓글 작성 시도:', content);

                        const response = await fetch('/api/comments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                postId: this.postId,
                                userId: 1, // 임시 사용자 ID
                                content: content,
                                parentId: null
                            })
                        });

                        const result = await response.json();
                        console.log('댓글 작성 응답:', result);

                        if (result.success) {
                            $('.comment-input').val(''); // 입력창 비우기
                            this.showToast('댓글이 등록되었습니다.', 'success');

                            // 댓글 목록 다시 로드
                            await this.loadComments();
                        } else {
                            this.showToast(result.message || '댓글 작성에 실패했습니다.', 'error');
                        }
                    } catch (error) {
                        console.error('댓글 작성 실패:', error);
                        this.showToast('댓글 작성에 실패했습니다.', 'error');
                    }
                },

                renderComments(comments) {
                    const container = $('.comments-list');
                    container.empty(); // 기존 내용 제거

                    if (comments.length === 0) {
                        container.append('<p class="no-comments">아직 댓글이 없습니다.</p>');
                        return;
                    }

                    comments.forEach(comment => {
                        const html = `
                            <div class="comment-item" data-comment-id="${comment.id}">
                                <img src="${comment.userProfileImage || '/api/placeholder/40/40'}"
                                     alt="${comment.userNickname}" class="comment-avatar">
                                <div class="comment-content">
                                    <div class="comment-header">
                                        <span class="comment-author">${comment.userNickname}</span>
                                        <span class="comment-date">${this.formatDate(comment.createdAt)}</span>
                                    </div>
                                    <p class="comment-text">${comment.content}</p>
                                    <div class="comment-actions">
                                        <div class="comment-action comment-like-btn" data-comment-id="${comment.id}">
                                            <i class="fas fa-heart"></i>
                                            <span class="like-count">${comment.likeCount || 0}</span>
                                        </div>
                                        <div class="comment-action comment-dislike-btn" data-comment-id="${comment.id}">
                                            <i class="fas fa-heart-broken"></i>
                                            <span class="dislike-count">${comment.dislikeCount || 0}</span>
                                        </div>
                                        <div class="comment-action reply-btn">
                                            <i class="far fa-comment"></i>
                                            <span>답글</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.append(html);
                    });

                    console.log('댓글 렌더링 완료, 생성된 요소 수:', $('.comment-item').length);
                },

                updateCommentCount(count) {
                    $('.comments-count').text(count);
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const diffDays = Math.floor(diffHours / 24);

                    if (diffMins < 1) return '방금 전';
                    if (diffMins < 60) return `${diffMins}분 전`;
                    if (diffHours < 24) return `${diffHours}시간 전`;
                    if (diffDays < 7) return `${diffDays}일 전`;

                    return date.toLocaleDateString('ko-KR');
                },

                showToast(message, type = 'info') {
                    const colors = {
                        success: '#28a745',
                        error: '#dc3545',
                        warning: '#ffc107',
                        info: '#17a2b8'
                    };

                    const toast = $(`<div style="
                        position: fixed; top: 20px; right: 20px;
                        background: ${colors[type] || colors.info};
                        color: ${type === 'warning' ? '#212529' : 'white'};
                        padding: 15px 20px;
                        border-radius: 6px;
                        z-index: 9999;
                        font-weight: 500;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    ">${message}</div>`);

                    $('body').append(toast);

                    setTimeout(() => toast.css('opacity', '1'), 10);
                    setTimeout(() => {
                        toast.css('opacity', '0');
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                }
            };

            // 댓글 매니저 시작
            commentManager.init();

            // 전역 변수로 등록 (기존 코드 호환성을 위해 createComment만 노출)
            window.commentManager = {
                createComment: (parentId = null) => {
                    if (parentId) {
                        console.log('대댓글 기능은 아직 구현 중입니다.');
                    } else {
                        commentManager.createComment();
                    }
                }
            };

            // 기존 게시글 상세 기능들...
            $('#backButton').click(function () {
                window.history.back();
            });

            $('#likeButton').click(function () {
                $(this).toggleClass('active');
                if ($(this).hasClass('active')) {
                    $(this).find('i').removeClass('far').addClass('fas');
                    $(this).find('span').text('좋아요 취소');
                    commentManager.showToast('게시글을 좋아요 했습니다.', 'success');
                } else {
                    $(this).find('i').removeClass('fas').addClass('far');
                    $(this).find('span').text('좋아요');
                    commentManager.showToast('좋아요를 취소했습니다.', 'info');
                }
            });

            $('#bookmarkButton').click(function () {
                $(this).toggleClass('active');
                if ($(this).hasClass('active')) {
                    $(this).find('i').removeClass('far').addClass('fas');
                    $(this).find('span').text('저장됨');
                    commentManager.showToast('게시글을 저장했습니다.', 'success');
                } else {
                    $(this).find('i').removeClass('fas').addClass('far');
                    $(this).find('span').text('저장');
                    commentManager.showToast('저장을 취소했습니다.', 'info');
                }
            });

            $('#followButton').click(function () {
                $(this).toggleClass('following');
                if ($(this).hasClass('following')) {
                    $(this).text('팔로잉');
                    commentManager.showToast('작성자를 팔로우 했습니다.', 'success');
                } else {
                    $(this).text('팔로우');
                    commentManager.showToast('팔로우를 취소했습니다.', 'info');
                }
            });
        });

        function deletePost() {
            if (confirm('정말 이 게시글을 삭제하시겠습니까?')) {
                fetch(`/api/posts/${[[${dto.id}]]}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('게시글이 삭제되었습니다.');
                            window.location.href = '/post';
                        } else {
                            alert('게시글 삭제에 실패했습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('게시글 삭제 중 오류가 발생했습니다.');
                    });
            }
        }
    </script>
</th:block>
</body>
</html>