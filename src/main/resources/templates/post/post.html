<!--post.html-->

<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<th:block layout:fragment="style">
    <link rel="stylesheet" th:href="@{/css/post.css}">

    <!-- ì¶”ê°€ ìŠ¤íƒ€ì¼: ë¦¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ í‘œì‹œìš© -->
    <style>
        /* ê²Œì‹œê¸€ ì¹´ë“œ ì´ë¯¸ì§€ */
        .post-image {
            width: 130px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin: 10px 0;
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .post-image:hover {
            transform: scale(1.05);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .post-image {
                width: 100px;
                height: 70px;
            }
        }

    </style>
</th:block>

<body>
<th:block layout:fragment="content">

    <!-- ì‚¬ìš©ì ì„ íƒ íƒ­ -->
    <div class="user-selection">
        <div class="user-tab active">
            <i class="far fa-user"></i>
            ë‚˜ì˜ ì„ íƒ
        </div>
        <div class="user-tab">
            <i class="fas fa-map-marker-alt"></i>
            ê·¼ì²˜ ë™í–¥
        </div>
    </div>

    <!-- íŠ¸ë Œë”© í† í”½ -->
<!--    <div class="trending-topics">-->
<!--        <div class="topic-badge active"># ì¸ê¸° ì—¬í–‰ì§€</div>-->
<!--        <div class="topic-badge"># ì œì£¼ë„</div>-->
<!--        <div class="topic-badge"># ë§›ì§‘íˆ¬ì–´</div>-->
<!--        <div class="topic-badge"># ìœ ëŸ½ì—¬í–‰</div>-->
<!--        <div class="topic-badge"># ë°°ë‚­ì—¬í–‰</div>-->
<!--        <div class="topic-badge"># í”„ë¼í•˜</div>-->
<!--        <div class="topic-badge"># ë™í–‰êµ¬í•¨</div>-->
<!--    </div>-->

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-navigation">
        <div class="tab active" data-tab="all" onclick="location.href='/post'">í¬ìŠ¤íŠ¸</div>
        <div class="tab" data-tab="companion" onclick="location.href='/travel'">ì¶”ì²œ ì—¬í–‰ê²½ë¡œ</div>
        <div class="tab" data-tab="post" onclick="location.href='/chat'">ì±„íŒ…</div>
        <div class="tab" data-tab="explorer"></div>
        <div class="tab-indicator"></div>
    </div>

    <!-- ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
    <div class="search-container">
        <form id="searchForm" action="/post/search" method="get">
            <div class="search-input-wrap">
                <i class="fas fa-search search-icon-input"></i>
                <input type="text" class="search-input" name="keyword"
                       th:value="${searchValue}" placeholder="ì „ì„¸ê³„ ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ ë¨¹ë²„ë ¤ë­ì•¼">
                <input type="hidden" name="page" value="1">
            </div>
        </form>
    </div>

    <div class="trending-topics">
        <a href="/post" class="topic-badge" th:classappend="${searchType == null ? 'active' : ''}">
            # ì „ì²´ë³´ê¸°
        </a>
        <!-- ë™ì ìœ¼ë¡œ ì¸ê¸° íƒœê·¸ í‘œì‹œ -->
        <a th:each="tag : ${topTags}"
           th:href="@{/post/search(tag=${tag})}"
           class="topic-badge"
           th:classappend="${searchType == 'tag' && searchValue == tag ? 'active' : ''}">
            <span th:text="${tag}"></span>
        </a>
    </div>

    <!-- ì •ë ¬ ì˜µì…˜ -->
    <div class="sort-options">
        <div class="sort-dropdown">
            ìµœì‹ ìˆœ <i class="fas fa-chevron-down"></i>
        </div>
        <div class="view-options">
            <div class="view-option active">
                <i class="fas fa-th-list"></i>
            </div>
            <div class="view-option">
                <i class="fas fa-th"></i>
            </div>
        </div>
    </div>

    <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
    <div class="post-list">
        <!-- ê²Œì‹œê¸€ ë°˜ë³µ -->
        <div class="post-card" th:each="dto : ${result.dtoList}">
            <div class="post-header">
                <span class="category-badge">ë™í–‰</span>
                <div class="post-header-icons">
                    <i class="far fa-bookmark post-header-icon"></i>
                    <i class="fas fa-share-alt post-header-icon"></i>
                </div>
            </div>
            <div class="post-content">
                <h3 class="post-title">[[${dto.title}]]</h3>
                <div class="post-tags">
                    <span class="post-tag" th:each="tag : ${dto.tags}" th:text="'#' + ${tag}"></span>
                </div>

                <!-- ê°€ì¥ ê¹”ë”í•œ ë²„ì „: ì´ë¯¸ì§€ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ -->
                <div th:if="${dto.imageUrls != null and !dto.imageUrls.isEmpty()}" class="post-image-container">
                    <img th:src="${dto.imageUrls[0]}"
                         alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€"
                         class="post-image"
                         onerror="this.parentElement.style.display='none';">
                </div>

                <!-- ë˜ëŠ” ë” ì½ê¸° ì‰½ê²Œ -->
                <p class="post-text">
                    <span th:text="${#strings.abbreviate(dto.content, 150)}"></span>
                </p>
                <div class="post-meta">
                    <div class="post-author">
                        <img th:if="${dto.authorProfileImage != null}"
                             th:src="@{/images/profiles/{fn}(fn=${dto.authorProfileImage})}"
                             alt="í”„ë¡œí•„" class="profile-pic"
                             style="width:28px; height:28px; object-fit:cover;"/>

                        <img th:if="${dto.authorProfileImage == null}"
                             src="/images/default-profile.png"
                             alt="í”„ë¡œí•„" class="profile-pic"
                             style="width:28px; height:28px; object-fit:cover;"/>
                        <span th:text="${dto.authorNickname}">ì‘ì„±ì</span>
                    </div>
                    <span class="post-date">[[${dto.elapsedTime}]]</span>
                </div>
                <a th:href="@{'/post/' + ${dto.id}}" class="view-btn">ìì„¸íˆ ë³´ê¸°</a>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="pagination-container" th:if="${result.totalPage > 1}">
        <div class="pagination">
            <!-- ì´ì „ í˜ì´ì§€ ê·¸ë£¹ -->
            <a th:if="${result.prev}"
               th:href="@{/post(page=${result.start - 1})}"
               class="page-prev">
                <i class="fas fa-chevron-left"></i>
            </a>
            <span th:if="${!result.prev}" class="page-prev disabled">
                <i class="fas fa-chevron-left"></i>
            </span>

            <!-- í˜ì´ì§€ ë²ˆí˜¸ë“¤ -->
            <th:block th:each="page : ${result.pageList}">
                <span th:if="${page == result.page}" class="current" th:text="${page}"></span>
                <a th:if="${page != result.page}"
                   th:href="@{/post(page=${page})}"
                   th:text="${page}"></a>
            </th:block>

            <!-- ë‹¤ìŒ í˜ì´ì§€ ê·¸ë£¹ -->
            <a th:if="${result.next}"
               th:href="@{/post(page=${result.end + 1})}"
               class="page-next">
                <i class="fas fa-chevron-right"></i>
            </a>
            <span th:if="${!result.next}" class="page-next disabled">
                <i class="fas fa-chevron-right"></i>
            </span>
        </div>

        <!-- í˜ì´ì§€ ì •ë³´ í‘œì‹œ -->
        <div class="page-info">
            [[${result.page}]] / [[${result.totalPage}]] í˜ì´ì§€
        </div>
    </div>

    <!-- ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° -->
    <div th:if="${result.dtoList.isEmpty()}" class="no-data">
        <p>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <nav th:replace="~{layout/fragments/nav :: navbar}"></nav>
    <script>
        // íƒ­ ë„¤ë¹„ê²Œì´ì…˜
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.tab');
            const indicator = document.querySelector('.tab-indicator');

            function setIndicatorPosition(activeTab) {
                const tabRect = activeTab.getBoundingClientRect();
                const navRect = document.querySelector('.tab-navigation').getBoundingClientRect();

                indicator.style.width = `${tabRect.width}px`;
                indicator.style.left = `${tabRect.left - navRect.left}px`;
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    setIndicatorPosition(this);
                });
            });

            // ì´ˆê¸° ì¸ë””ì¼€ì´í„° ìœ„ì¹˜ ì„¤ì •
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                setIndicatorPosition(activeTab);
            }

            // ì°½ í¬ê¸° ë³€ê²½ì‹œ ì¸ë””ì¼€ì´í„° ìœ„ì¹˜ ì¡°ì •
            window.addEventListener('resize', function () {
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    setIndicatorPosition(activeTab);
                }
            });

            // ğŸ”§ ì´ë¯¸ì§€ í´ë¦­ ì‹œ ìƒì„¸ë³´ê¸°ë¡œ ì´ë™
            document.querySelectorAll('.post-image').forEach(image => {
                image.addEventListener('click', function() {
                    const postCard = this.closest('.post-card');
                    const viewBtn = postCard.querySelector('.view-btn');
                    if (viewBtn) {
                        viewBtn.click();
                    }
                });
            });
        });

        // ì‚¬ìš©ì ì„ íƒ íƒ­
        const userTabs = document.querySelectorAll('.user-tab');
        userTabs.forEach(tab => {
            tab.addEventListener('click', function () {
                userTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // í† í”½ ë°°ì§€
        const topicBadges = document.querySelectorAll('.topic-badge');
        topicBadges.forEach(badge => {
            badge.addEventListener('click', function () {
                this.classList.toggle('active');
            });
        });

        // ë·° ì˜µì…˜
        const viewOptions = document.querySelectorAll('.view-option');
        viewOptions.forEach(option => {
            option.addEventListener('click', function () {
                viewOptions.forEach(o => o.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // ê²€ìƒ‰ ì…ë ¥ë€ì—ì„œ Enter í‚¤ ëˆ„ë¥´ë©´ ê²€ìƒ‰ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('.search-input');
            const searchForm = document.getElementById('searchForm');

            if (searchInput && searchForm) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchForm.submit();
                    }
                });
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ë§í¬ì— ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ìœ ì§€
            const paginationLinks = document.querySelectorAll('.pagination a');

            if (paginationLinks.length > 0) {
                const searchType = '[[${searchType}]]';
                const searchValue = '[[${searchValue}]]';

                paginationLinks.forEach(link => {
                    const href = link.getAttribute('href');

                    if (href && searchType && searchValue) {
                        const newHref = href + (searchType === 'tag'
                            ? '&tag=' + searchValue
                            : '&keyword=' + searchValue);
                        link.setAttribute('href', newHref);
                    }
                });
            }
        });
    </script>
</th:block>
</body>
</html>