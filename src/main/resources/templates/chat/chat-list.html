<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/main}">

<th:block layout:fragment="style">
	<link rel="stylesheet" th:href="@{/css/chat.css}">
</th:block>

<body>
	<th:block layout:fragment="content">
		<!-- ì±„íŒ…ë°© ëª©ë¡ ì˜ì—­ -->
		<div class="chat-list-container">
			<!-- ê²€ìƒ‰ ë° í•„í„° ì˜ì—­ -->
			<div class="chat-controls">
				<h3 class="chat-list-title">ì±„íŒ…ë°© ëª©ë¡</h3>
				<div class="create-chat" id="create-chat-btn">
					<i class="fas fa-plus"></i> ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°
				</div>
			</div>

			<div class="search-box">
				<i class="fas fa-search search-icon"></i>
				<input type="text" class="search-input" placeholder="ì±„íŒ…ë°© ê²€ìƒ‰..." id="chat-search-input">

				<ul id="suggestion-list" class="suggestion-list"></ul>
			</div>

			<div class="chat-filters">
				<div class="chat-filter active" data-filter="all">ì „ì²´</div>
				<div class="chat-filter" data-filter="popular">ì¸ê¸°</div>
				<div class="chat-filter" data-filter="mine">ë‚˜ì˜ ì±„íŒ…ë°©</div>
			</div>

			<!-- ì±„íŒ…ë°© ëª©ë¡ ì˜ì—­ -->
			<div class="chat-list">
				<div class="chat-room" th:each="room : ${chatRooms}" th:attr="data-id=${room.id}">

					<!-- ì™¼ìª½: ì¸ë„¤ì¼ + ì°¸ì—¬ì ìˆ˜ -->
					<div class="chat-left">
						<img th:src="${room.thumbnailImageUrl != null ? room.thumbnailImageUrl : '/api/placeholder/60/60'}"
							alt="ì±„íŒ…ë°© ì´ë¯¸ì§€" class="chat-avatar" />
						<div class="chat-participant-count">
							ì°¸ì—¬ì: <span th:text="${room.participantCount}">0</span>ëª…
						</div>
					</div>

					<!-- ì¤‘ì•™ ë‚´ìš© -->
					<div class="chat-center">
						<div class="chat-title" th:text="${room.title}">ì±„íŒ…ë°© ì œëª©</div>

						<div class="chat-hashtags">
							<div class="chat-hashtag" th:each="tag : ${room.hashtags}" th:text="'#' + ${tag}">#í•´ì‹œíƒœê·¸
							</div>
						</div>

						<div class="chat-owner">
							ë°©ì¥: <span th:text="${room.ownerNickname}"></span>
						</div>
					</div>

					<!-- ì˜¤ë¥¸ìª½: ì‹œê°„ + ì¢‹ì•„ìš” -->
					<div class="chat-right">
						<div class="chat-time" th:text="${#temporals.format(room.createdAt, 'yy-MM-dd HH:mm')}">ì‹œê°„</div>
						<div class="chat-likes">
							â¤ï¸ <span th:text="${room.likeCount}">0</span>
						</div>
					</div>
				</div>
			</div>

			<!-- ë”ë³´ê¸° ë²„íŠ¼ -->
			<div class="chat-list"></div>
			<div class="load-more-container">
				<button id="load-more-btn" class="load-more-btn" style="display: none;">ë”ë³´ê¸°</button>
			</div>


			<!-- ì±„íŒ…ë°© ìƒì„¸ ëª¨ë‹¬ -->
			<div class="modal-overlay" id="chat-detail-modal">
				<div class="modal">
					<div class="modal-header">
						<h3 class="modal-title">ì±„íŒ…ë°© ìƒì„¸ ì •ë³´</h3>
						<div class="modal-close" id="close-detail-modal">
							<i class="fas fa-times"></i>
						</div>
					</div>
					<div class="modal-body">
						<p id="detail-title"></p>
						<p id="detail-description"></p>
						<p id="detail-notice"></p>
						<div id="detail-hashtags"></div>
					</div>
					<div class="modal-footer">
						<button class="create-button" id="enter-chatroom">ì±„íŒ…ë°© ì…ì¥í•˜ê¸°</button>
						<button class="cancel-button" id="leave-chatroom" style="display:none;">ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>
						<button class="create-button" id="edit-chatroom" style="display:none;">ì±„íŒ…ë°© ìˆ˜ì •</button>
						<button class="cancel-button" id="delete-chatroom"
							style="display:none; background-color: #f44336; color: white;">ì±„íŒ…ë°© ì‚­ì œ
						</button>
					</div>
				</div>
			</div>


			<!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ -->
			<div class="modal-overlay" id="create-chat-modal">
				<div class="modal">
					<div class="modal-header">
						<h3 class="modal-title">ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</h3>
						<div class="modal-close" id="close-create-modal">
							<i class="fas fa-times"></i>
						</div>
					</div>
					<div class="form-group">
						<label class="form-label">ì±„íŒ…ë°© ì œëª©</label>
						<input type="text" class="form-input" id="chat-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 30ì)"
							maxlength="30">
					</div>

					<div class="form-group">
						<label class="form-label">ì¸ë„¤ì¼ ì´ë¯¸ì§€ (ì„ íƒ)</label>
						<input type="file" class="form-input" id="chat-thumbnail" accept="image/png, image/jpeg">
					</div>


					<div class="form-group">
						<label class="form-label">í•´ì‹œíƒœê·¸ (ìµœëŒ€ 5ê°œ)</label>
						<div class="hashtag-input">
							<input type="text" class="hashtag-input-field" placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter...">
						</div>
					</div>
					<div class="form-group">
						<label class="form-label">ê³µì§€ì‚¬í•­ (ì„ íƒ)</label>
						<textarea class="form-textarea" id="chat-notice" placeholder="ì±„íŒ…ë°© ê³µì§€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 100ì)"
							maxlength="100"></textarea>
					</div>
					<div class="form-group">
						<label class="form-label">ì„¤ëª…ê¸€ (ì„ íƒ)</label>
						<textarea class="form-textarea" id="chat-description" placeholder="ì±„íŒ…ë°©ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 200ì)"
							maxlength="200"></textarea>
					</div>
					<div class="modal-footer">
						<button class="cancel-button" id="cancel-create">ì·¨ì†Œ</button>
						<button class="create-button" id="confirm-create">ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
					</div>
				</div>
			</div>
		</div>

		<!-- ì±„íŒ…ë°© ìˆ˜ì • ëª¨ë‹¬ -->
		<div class="modal-overlay" id="edit-chat-modal">
			<div class="modal">
				<div class="modal-header">
					<h3 class="modal-title">ì±„íŒ…ë°© ìˆ˜ì •</h3>
					<div class="modal-close" id="close-edit-modal">
						<i class="fas fa-times"></i>
					</div>
				</div>

				<div class="form-group">
					<label class="form-label">ì±„íŒ…ë°© ì œëª©</label>
					<input type="text" class="form-input" id="edit-chat-title" maxlength="30" />
				</div>
				
				<div class="form-group">
				  <label class="form-label">ì¸ë„¤ì¼ ì´ë¯¸ì§€ (ì„ íƒ)</label>
				  <input type="file" class="form-input" id="edit-chat-thumbnail" accept="image/png, image/jpeg">
				</div>

				<div class="form-group">
					<label class="form-label">í•´ì‹œíƒœê·¸ (ìµœëŒ€ 5ê°œ)</label>
					<div class="hashtag-input" id="edit-hashtag-container">
						<!-- ê¸°ì¡´ íƒœê·¸ ì±„ì›Œì§ -->
						<input type="text" class="hashtag-input-field" placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter..." />
					</div>
				</div>

				<div class="form-group">
					<label class="form-label">ê³µì§€ì‚¬í•­</label>
					<textarea class="form-textarea" id="edit-chat-notice" maxlength="100"></textarea>
				</div>

				<div class="form-group">
					<label class="form-label">ì„¤ëª…ê¸€</label>
					<textarea class="form-textarea" id="edit-chat-description" maxlength="200"></textarea>
				</div>

				<div class="modal-footer">
					<button class="cancel-button" id="cancel-edit">ì·¨ì†Œ</button>
					<button class="create-button" id="confirm-edit">ì €ì¥</button>
				</div>
			</div>
		</div>

		<script>

			// ì±„íŒ…ë°© ì •ë ¬ íƒ­
			let currentTab = 'ì „ì²´';
			let offset = 0;
			const limit = 20;

			//ì±„íŒ…ë°© ì•„ì´ë””
			let selectedRoomId = null;

			//ê²€ìƒ‰ ìë™ì™„ì„± ì¶”ì²œ ê¸°ëŠ¥
			document.addEventListener('DOMContentLoaded', function () {
				const input = document.getElementById('chat-search-input');
				const suggestionList = document.getElementById('suggestion-list');
				let debounceTimer;

				let selectedIndex = -1;
				input.addEventListener('keydown', function (e) {
					const items = suggestionList.querySelectorAll('li');
					if (items.length === 0) return;

					if (e.key === 'ArrowDown') {
						e.preventDefault();
						selectedIndex = (selectedIndex + 1) % items.length;
						updateActiveItem(items);
					} else if (e.key === 'ArrowUp') {
						e.preventDefault();
						selectedIndex = (selectedIndex - 1 + items.length) % items.length;
						updateActiveItem(items);
					} else if (e.key === 'Enter') {
						if (selectedIndex >= 0 && selectedIndex < items.length) {
							e.preventDefault();
							items[selectedIndex].click();
						}
					}
				});

				function updateActiveItem(items) {
					items.forEach((item, index) => {
						if (index === selectedIndex) {
							item.classList.add('active');
							item.scrollIntoView({ block: 'nearest' });
						} else {
							item.classList.remove('active');
						}
					});
				}


				input.addEventListener('input', function () {
					const keyword = this.value.trim();

					// debounce ì²˜ë¦¬ (300ms)
					clearTimeout(debounceTimer);
					debounceTimer = setTimeout(() => {
						if (keyword.length > 0) {
							fetch(`/api/suggestions?keyword=${encodeURIComponent(keyword)}`)
									.then(response => response.json())
									.then(suggestions => {
										showSuggestions(suggestions);
									});
						} else {
							suggestionList.innerHTML = '';
						}
					}, 300);
				});

				// ì±„íŒ…ë°© ê²€ìƒ‰ ìœ í˜• ìŠ¤íƒ€ì¼ êµ¬ë¶„
				function showSuggestions(suggestions) {
					suggestionList.innerHTML = '';
					selectedIndex = -1;

					suggestions.forEach(item => {
						const li = document.createElement('li');
						li.textContent = item;

						// ìœ í˜•ë³„ êµ¬ë¶„ëœ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ë¶€ì—¬
						if (item.startsWith('#')) {
							li.classList.add('hashtag-suggestion');
						} else if (item.startsWith('@')) {
							li.classList.add('owner-suggestion');
						}

						li.addEventListener('click', function () {
							input.value = item.startsWith('#') || item.startsWith('@') ? item.slice(1) : item;
							suggestionList.innerHTML = '';
							input.dispatchEvent(new Event('input'));
						});
						suggestionList.appendChild(li);
					});
				}


				// ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
				document.addEventListener('click', function (e) {
					if (!input.contains(e.target) && !suggestionList.contains(e.target)) {
						suggestionList.innerHTML = '';
					}
				});

				loadChatRooms();
			});

			// ëª¨ë‹¬ ë²„íŠ¼ ë°”ì¸ë”©ì„ ìœ„í•œ í•¨ìˆ˜
			function bindModalButtons(roomId, roomRole) {
				selectedRoomId = roomId;

				const editBtn = document.getElementById('edit-chatroom');
				const deleteBtn = document.getElementById('delete-chatroom');
				const leaveBtn = document.getElementById('leave-chatroom');

				// í´ë¦­ ì´ë²¤íŠ¸ ì œê±° (ê¸°ì¡´ì— ìˆì—ˆìœ¼ë©´)
				editBtn.onclick = null;
				deleteBtn.onclick = null;
				leaveBtn.onclick = null;

				// ì—­í• ì— ë”°ë¼ ë²„íŠ¼ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
				if (roomRole === 'OWNER') {
					editBtn.style.display = 'inline-block';
					deleteBtn.style.display = 'inline-block';
					leaveBtn.style.display = 'none';
				} else if (roomRole === 'JOINED') {
					editBtn.style.display = 'none';
					deleteBtn.style.display = 'none';
					leaveBtn.style.display = 'inline-block';
				} else {
					editBtn.style.display = 'none';
					deleteBtn.style.display = 'none';
					leaveBtn.style.display = 'none';
				}
			}

			// ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° í•¨ìˆ˜
			function openModal(modal) {
				modal.classList.add('active');
				document.body.style.overflow = 'hidden';
			}
			function closeModal(modal) {
				modal.classList.remove('active');
				document.body.style.overflow = '';
			}

			document.addEventListener('DOMContentLoaded', function () {
				// ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬
				const createChatBtn = document.getElementById('create-chat-btn');
				const createChatModal = document.getElementById('create-chat-modal');
				const closeCreateModal = document.getElementById('close-create-modal');
				const cancelCreate = document.getElementById('cancel-create');
				const confirmCreate = document.getElementById('confirm-create');
				const emptyStateBtn = document.querySelector('.create-first-chat');

				// ì±„íŒ…ë°© í•„í„°
				const chatFilters = document.querySelectorAll('.chat-filter');

				// ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ ì—´ê¸°
				createChatBtn.addEventListener('click', function () {
					openModal(createChatModal);
				});

				// ë¹ˆ ìƒíƒœì—ì„œ ì±„íŒ…ë°© ìƒì„± ë²„íŠ¼
				if (emptyStateBtn) {
					emptyStateBtn.addEventListener('click', function () {
						openModal(createChatModal);
					});
				}

				// ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ ë‹«ê¸°
				closeCreateModal.addEventListener('click', function () {
					closeModal(createChatModal);
				});

				cancelCreate.addEventListener('click', function () {
					closeModal(createChatModal);
				});

				// ì±„íŒ…ë°© ìƒì„± í™•ì¸
				confirmCreate.addEventListener('click', async function () {
					const title = document.getElementById('chat-title').value;
					const notice = document.getElementById('chat-notice').value;
					const description = document.getElementById('chat-description').value;

					// í•´ì‹œíƒœê·¸ ì¶”ì¶œ
					const hashtagElements = document.querySelectorAll('.hashtag');
					const hashtags = Array.from(hashtagElements).map(el => el.textContent.replace("Ã—", "").trim().replace("#", ""));

					if (!title) {
						alert('ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
						return;
					}

					try {
						// 1. ì±„íŒ…ë°© ìƒì„± ìš”ì²­
						// ì¸ë„¤ì¼ ìœ íš¨ì„± ê²€ì‚¬
						const thumbnailFile = document.getElementById('chat-thumbnail').files[0];
						if (thumbnailFile) {
						    const type = thumbnailFile.type;
						    if (!(type === "image/png" || type === "image/jpeg")) {
						        alert("ì´ë¯¸ì§€ íŒŒì¼(png, jpg)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
						        return;
						    }
						}

						const formData = new FormData();
						formData.append("title", title);
						formData.append("notice", notice);
						formData.append("description", description);
						hashtags.forEach(tag => formData.append("hashtags", tag));
						if (thumbnailFile) formData.append("thumbnailImage", thumbnailFile);

						const response = await fetch('/api/chatrooms', {
						    method: 'POST',
						    body: formData
						});

						const newRoomId = await response.json();

						// 2. ì±„íŒ…ë°© ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
						const detailResponse = await fetch(`/api/chatrooms/${newRoomId}`);
						const room = await detailResponse.json();

						// 3. ëª©ë¡ì— ì±„íŒ…ë°© ë™ì  ì¶”ê°€
						const chatList = document.querySelector('.chat-list');
						const div = document.createElement('div');
						div.className = 'chat-room';
						div.setAttribute('data-id', room.id);
						div.innerHTML = `
						  <div class="chat-left">
							<img src="${room.thumbnailImageUrl || '/api/placeholder/100/100'}" class="chat-avatar" alt="ì¸ë„¤ì¼" />
						      <div class="chat-participant-count">
						          ì°¸ì—¬ì: ${room.participantCount}ëª…
						      </div>
						  </div>
						  <div class="chat-center">
						      <div class="chat-title">${room.title}</div>
						      <div class="chat-hashtags">
						          ${room.hashtags.map(tag => `<div class="chat-hashtag">#${tag}</div>`).join("")}
						      </div>
						      <div class="chat-owner">ë°©ì¥: ${room.ownerNickname}</div>
						  </div>
						  <div class="chat-right">
						      <div class="chat-time">${new Date(room.createdAt).toLocaleString('ko-KR')}</div>
						      <div class="chat-likes">â¤ï¸ ${room.likeCount}</div>
						  </div>
						`;

						div.addEventListener('click', async () => {
						  try {
						    const res = await fetch(`/api/chatrooms/${room.id}`);
						    const roomDetail = await res.json();

						    // ìƒì„¸ ëª¨ë‹¬ ì •ë³´ ì„¸íŒ…
						    document.getElementById('detail-title').textContent = roomDetail.title;
						    document.getElementById('detail-description').textContent = roomDetail.description || '-';
						    document.getElementById('detail-notice').textContent = roomDetail.notice || '-';
						    document.getElementById('detail-hashtags').innerHTML =
						      roomDetail.hashtags.map(tag => `<span>#${tag}</span>`).join(' ');

						    // ë²„íŠ¼ ì œì–´ (ë°©ì¥ ì—¬ë¶€ ë“±)
						    const role = roomDetail.myRole;
						    document.getElementById('edit-chatroom').style.display = role === 'OWNER' ? 'inline-block' : 'none';
						    document.getElementById('delete-chatroom').style.display = role === 'OWNER' ? 'inline-block' : 'none';
						    document.getElementById('leave-chatroom').style.display = role === 'JOINED' ? 'inline-block' : 'none';

						    // ëª¨ë‹¬ ì—´ê¸°
							bindModalButtons(roomDetail.id, roomDetail.myRole);
						    openModal(document.getElementById('chat-detail-modal'));
						  } catch (err) {
						    alert("ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
						    console.error(err);
						  }
						});

						chatList.prepend(div);

						// ëª¨ë‹¬ ë‹«ê¸° ë° ì´ˆê¸°í™”
						closeModal(createChatModal);
						document.getElementById('chat-title').value = '';
						document.getElementById('chat-notice').value = '';
						document.getElementById('chat-description').value = '';
						document.querySelectorAll('.hashtag').forEach(el => el.remove());

					} catch (error) {
						alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
						console.error(error);
					}
				});

				// ì±„íŒ…ë°© ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
				document.getElementById('delete-chatroom').addEventListener('click', async () => {
					if (!selectedRoomId) return;

					if (!confirm("ì •ë§ ì´ ì±„íŒ…ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

					try {
						const res = await fetch(`/api/chatrooms/${selectedRoomId}`, {
							method: 'DELETE'
						});

						if (!res.ok) {
							const errorText = await res.text();
							throw new Error(errorText || "ì‚­ì œ ì‹¤íŒ¨");
						}

						alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
						window.location.reload();
					} catch (err) {
						alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
					}
				});



				//í•´ì‹œíƒœê·¸ ì…ë ¥ ì´ë²¤íŠ¸ ë“±ë¡ (ìƒì„± + ìˆ˜ì • í¼ ëª¨ë‘ ëŒ€ì‘)
				// - ìƒˆ íƒœê·¸ ìƒì„± ì‹œ "Ã—" í´ë¦­ìœ¼ë¡œ ì œê±° ê°€ëŠ¥
				// í•´ì‹œíƒœê·¸ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë°”ì¸ë”©í•˜ëŠ” í•¨ìˆ˜ (ìƒì„±/ìˆ˜ì • ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥)
				function bindHashtagInputs() {
					document.querySelectorAll('.hashtag-input-field').forEach(input => {
						input.removeEventListener('keydown', handleHashtagKeydown);
						input.addEventListener('keydown', handleHashtagKeydown);
					});
				}

				function handleHashtagKeydown(e) {
					if (e.key === 'Enter' && this.value.trim()) {
						e.preventDefault();

						const container = this.closest('.hashtag-input');
						const currentTags = container.querySelectorAll('.hashtag').length;

						if (currentTags >= 5) {
							alert('í•´ì‹œíƒœê·¸ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
							return;
						}

						const newTagText = this.value.trim();

						// âœ… ì¤‘ë³µ íƒœê·¸ ë°©ì§€
						const duplicate = [...container.querySelectorAll('.hashtag')].some(el =>
							el.textContent.replace("Ã—", "").trim().replace("#", "") === newTagText
						);
						if (duplicate) {
							alert('ì´ë¯¸ ì¶”ê°€ëœ í•´ì‹œíƒœê·¸ì…ë‹ˆë‹¤.');
							this.value = '';
							return;
						}

						const tag = document.createElement('div');
						tag.className = 'hashtag';
						tag.innerHTML = `#${newTagText} <span class="remove-hashtag">Ã—</span>`;
						tag.querySelector('.remove-hashtag').addEventListener('click', function () {
							tag.remove();
						});

						container.insertBefore(tag, this);
						this.value = '';
					}
				}
				// í•´ì‹œíƒœê·¸ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹¤í–‰ (ìƒì„± + ìˆ˜ì • í¼ ëª¨ë‘ ëŒ€ì‘)
				bindHashtagInputs();

				// ì±„íŒ…ë°© í•„í„° í´ë¦­ ì´ë²¤íŠ¸
				chatFilters.forEach(filter => {
					filter.addEventListener('click', function () {
						chatFilters.forEach(f => f.classList.remove('active'));
						this.classList.add('active');

						currentTab = this.dataset.filter;
						offset = 0;

						console.log("âœ… íƒ­ í´ë¦­ë¨:", currentTab);
						document.querySelector('.chat-list').innerHTML = '';
						loadChatRooms();
					});
				});


				// ì±„íŒ…ë°© í´ë¦­ ì´ë²¤íŠ¸ (ì±„íŒ…ë°© ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™)
				// ì±„íŒ…ë°© ìƒì„¸ì •ë³´ ëª¨ë‹¬ ìš”ì†Œ ì •ì˜
				const detailModal = document.getElementById('chat-detail-modal');
				const closeDetailModal = document.getElementById('close-detail-modal');
				const enterChatroomBtn = document.getElementById('enter-chatroom');


				// ìƒì„¸ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
				closeDetailModal.addEventListener('click', () => {
					closeModal(detailModal);
				});

				// ì…ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ chatroom.htmlë¡œ ì´ë™
				enterChatroomBtn.addEventListener('click', () => {
					if (selectedRoomId) {
						window.location.href = `chatroom.html?id=${selectedRoomId}`;
					}
				});

				const editChatroomBtn = document.getElementById('edit-chatroom');

				const editModal = document.getElementById('edit-chat-modal');
				const closeEditModal = document.getElementById('close-edit-modal');
				const cancelEditBtn = document.getElementById('cancel-edit');
				const confirmEditBtn = document.getElementById('confirm-edit');

				editChatroomBtn.addEventListener('click', async () => {
					if (!selectedRoomId) return;

					try {
						const res = await fetch(`/api/chatrooms/${selectedRoomId}`);
						const room = await res.json();

						// ê¸°ì¡´ ë‚´ìš© ì±„ìš°ê¸°
						document.getElementById('edit-chat-title').value = room.title || '';
						document.getElementById('edit-chat-notice').value = room.notice || '';
						document.getElementById('edit-chat-description').value = room.description || '';

						// í•´ì‹œíƒœê·¸
						const container = document.getElementById('edit-hashtag-container');
						container.querySelectorAll('.hashtag').forEach(el => el.remove());

						room.hashtags.forEach(tag => {
							const div = document.createElement('div');
							div.className = 'hashtag';
							div.innerHTML = `#${tag} <span class="remove-hashtag">Ã—</span>`;
							div.querySelector('.remove-hashtag').addEventListener('click', function () {
								div.remove();
							});
							container.insertBefore(div, container.querySelector('.hashtag-input-field'));
						});

						openModal(editModal);
					} catch (e) {
						alert('ìˆ˜ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
						console.error(e);
					}
				});

				confirmEditBtn.addEventListener('click', async () => {
					const title = document.getElementById('edit-chat-title').value;
					const notice = document.getElementById('edit-chat-notice').value;
					const description = document.getElementById('edit-chat-description').value;

					const hashtagElements = document.querySelectorAll('#edit-hashtag-container .hashtag');
					const hashtags = Array.from(hashtagElements).map(el => el.textContent.replace("Ã—", "").trim().replace("#", ""));

					const thumbnailFile = document.getElementById('edit-chat-thumbnail').files[0];
					if (thumbnailFile) {
						const type = thumbnailFile.type;
						if (!(type === "image/png" || type === "image/jpeg")) {
							alert("ì´ë¯¸ì§€ íŒŒì¼(png, jpg)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
							return;
						}
					}

					if (!title) {
						alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
						return;
					}

					try {
						const formData = new FormData();
						formData.append("title", title);
						formData.append("notice", notice);
						formData.append("description", description);
						hashtags.forEach(tag => formData.append("hashtags", tag));
						if (thumbnailFile) formData.append("thumbnailImage", thumbnailFile);

						const res = await fetch(`/api/chatrooms/${selectedRoomId}/edit-log`, {
							method: 'POST',
							body: formData
						});

						if (!res.ok) throw new Error('ìˆ˜ì • ì‹¤íŒ¨');

						alert('ì±„íŒ…ë°© ìˆ˜ì • ì™„ë£Œ!');
						closeModal(editModal);
						window.location.reload();
					} catch (err) {
						alert('ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
						console.error(err);
					}
				});


				closeEditModal.addEventListener('click', () => closeModal(editModal));
				cancelEditBtn.addEventListener('click', () => closeModal(editModal));

				// ê²€ìƒ‰ ê¸°ëŠ¥
				const searchInput = document.querySelector('.search-input');
				searchInput.addEventListener('input', function () {
					const searchTerm = this.value.toLowerCase();

					const chatRooms = document.querySelectorAll('.chat-room');


					chatRooms.forEach(room => {
						const title = room.querySelector('.chat-title').textContent.toLowerCase();
						const hashtags = Array.from(room.querySelectorAll('.chat-hashtag')).map(tag => tag.textContent.toLowerCase());
						const owner = room.querySelector('.chat-owner span')?.textContent.toLowerCase() || '';

						const matchTitle = title.includes(searchTerm);
						const matchHashtag = hashtags.some(tag => tag.includes(searchTerm));
						const matchOwner = owner.includes(searchTerm); // âœ… ì¶”ê°€

						if (matchTitle || matchHashtag || matchOwner) {
							room.style.display = 'flex';
						} else {
							room.style.display = 'none';
						}
					});
				});
			})


			// ì±„íŒ…ë°© ëª©ë¡ ë¡œë”© í•¨ìˆ˜
			async function loadChatRooms() {
				let endpoint = '/api/chatrooms';

				if (currentTab === 'popular') {
					endpoint += `/popular?offset=${offset}&limit=${limit}`;
				} else if (currentTab === 'mine') {
					endpoint += `/mine?offset=${offset}&limit=${limit}`;
				} else {
					endpoint += `?offset=${offset}&limit=${limit}`;
				}

				try {
					const response = await fetch(endpoint);
					const rooms = await response.json();

					console.log("ğŸ“¦ ì‘ë‹µ ë°ì´í„°:", rooms);

					if (offset === 0) {
						document.querySelector('.chat-list').innerHTML = '';
					}

					if (rooms.length === 0 && offset > 0) {
						alert('ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤. ë˜ëŠ” ì‚­ì œëœ ì±„íŒ…ë°©ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
						return;
					}

					renderChatRooms(rooms);

					if (rooms.length === limit) {
						if (!document.getElementById('load-more-btn')) {
							const btn = document.createElement('button');
							btn.textContent = 'ë”ë³´ê¸°';
							btn.id = 'load-more-btn';
							btn.className = 'load-more-btn';
							btn.addEventListener('click', () => {
								offset += limit;
								loadChatRooms();
							});
							document.querySelector('.chat-list-container').appendChild(btn);
						}
					} else {
						const existing = document.getElementById('load-more-btn');
						if (existing) existing.remove();
					}

				} catch (err) {
					alert('ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
					console.error(err);
				}
			}

			function renderChatRooms(rooms) {
				const chatList = document.querySelector('.chat-list');

				rooms.forEach(room => {
					const div = document.createElement('div');
					div.className = 'chat-room';
					div.setAttribute('data-id', room.id);

					div.innerHTML = `
      <div class="chat-left">
        <img src="${room.thumbnailImageUrl || '/api/placeholder/60/60'}" class="chat-avatar" />
        <div class="chat-participant-count">ì°¸ì—¬ì: ${room.participantCount}ëª…</div>
      </div>
      <div class="chat-center">
        <div class="chat-title">${room.title}</div>
        <div class="chat-hashtags">${room.hashtags.map(tag => `<div class="chat-hashtag">#${tag}</div>`).join('')}</div>
        <div class="chat-owner">ë°©ì¥: ${room.ownerNickname}</div>
      </div>
      <div class="chat-right">
        <div class="chat-time">${new Date(room.createdAt).toLocaleString('ko-KR')}</div>
        <div class="chat-likes">â¤ï¸ ${room.likeCount}</div>
      </div>
    `;


					div.addEventListener('click', async () => {
						try {
							const res = await fetch(`/api/chatrooms/${room.id}`);
							const roomDetail = await res.json();

							document.getElementById('detail-title').textContent = roomDetail.title;
							document.getElementById('detail-description').textContent = roomDetail.description || '-';
							document.getElementById('detail-notice').textContent = roomDetail.notice || '-';
							document.getElementById('detail-hashtags').innerHTML =
									roomDetail.hashtags.map(tag => `<span>#${tag}</span>`).join(' ');

							bindModalButtons(roomDetail.id, roomDetail.myRole);
							openModal(document.getElementById('chat-detail-modal'));
						} catch (err) {
							alert("ì±„íŒ…ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
							console.error(err);
						}
					});


					chatList.appendChild(div);
				});
			}

		</script>
	</th:block>
</body>

</html>