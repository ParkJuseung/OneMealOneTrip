<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/main}">

<th:block layout:fragment="style">
	<link rel="stylesheet" th:href="@{/css/chat.css}">
</th:block>

<body>
	<th:block layout:fragment="content">
		<!-- ì±„íŒ…ë°© ëª©ë¡ ì˜ì—­ -->
		<div class="chat-list-container">
			<!-- ê²€ìƒ‰ ë° í•„í„° ì˜ì—­ -->
			<div class="chat-controls">
				<h3 class="chat-list-title">ì±„íŒ…ë°© ëª©ë¡</h3>
				<div class="create-chat" id="create-chat-btn">
					<i class="fas fa-plus"></i> ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°
				</div>
			</div>

			<div class="search-box">
				<i class="fas fa-search search-icon"></i>
				<input type="text" class="search-input" placeholder="ì±„íŒ…ë°© ê²€ìƒ‰...">
			</div>

			<div class="chat-filters">
				<div class="chat-filter active">ì „ì²´</div>
				<div class="chat-filter">ğŸ”¥ì¸ê¸°</div>
				<div class="chat-filter">ë‚˜ì˜ ì±„íŒ…ë°©</div>
			</div>

			<!-- ì±„íŒ…ë°© ëª©ë¡ ì˜ì—­ - ìˆ˜ì •ëœ ë²„ì „ -->
			<div class="chat-list">
			    <div class="chat-room" th:each="room : ${chatRooms}" th:attr="data-id=${room.id}">
			        
			        <!-- ì™¼ìª½: ì¸ë„¤ì¼ + ì°¸ì—¬ì ìˆ˜ -->
			        <div class="chat-left">
			            <img th:src="${room.thumbnailImageUrl != null ? room.thumbnailImageUrl : '/api/placeholder/60/60'}"
			                 alt="ì±„íŒ…ë°© ì´ë¯¸ì§€" class="chat-avatar"/>
			            <div class="chat-participant-count">
			                ì°¸ì—¬ì: <span th:text="${room.participantCount}">0</span>ëª…
			            </div>
			        </div>

			        <!-- ì¤‘ì•™ ë‚´ìš© -->
			        <div class="chat-center">
			            <div class="chat-title" th:text="${room.title}">ì±„íŒ…ë°© ì œëª©</div>

			            <div class="chat-hashtags">
			                <div class="chat-hashtag" th:each="tag : ${room.hashtags}" th:text="'#' + ${tag}">#í•´ì‹œíƒœê·¸</div>
			            </div>

			            <div class="chat-owner">
			                ë°©ì¥: <span th:text="${room.ownerNickname}"></span>
			            </div>
			        </div>

			        <!-- ì˜¤ë¥¸ìª½: ì‹œê°„ + ì¢‹ì•„ìš” -->
			        <div class="chat-right">
			            <div class="chat-time" th:text="${#temporals.format(room.createdAt, 'yy-MM-dd HH:mm')}">ì‹œê°„</div>
			            <div class="chat-likes">
			                â¤ï¸ <span th:text="${room.likeCount}">0</span>
			            </div>
			        </div>
			    </div>
			</div>


			<!-- ì±„íŒ…ë°© ìƒì„¸ ëª¨ë‹¬ -->
			<div class="modal-overlay" id="chat-detail-modal">
				<div class="modal">
					<div class="modal-header">
						<h3 class="modal-title">ì±„íŒ…ë°© ìƒì„¸ ì •ë³´</h3>
						<div class="modal-close" id="close-detail-modal">
							<i class="fas fa-times"></i>
						</div>
					</div>
					<div class="modal-body">
						<p id="detail-title"></p>
						<p id="detail-description"></p>
						<p id="detail-notice"></p>
						<div id="detail-hashtags"></div>
					</div>
					<div class="modal-footer">
						<button class="create-button" id="enter-chatroom">ì±„íŒ…ë°© ì…ì¥í•˜ê¸°</button>
						<button class="cancel-button" id="leave-chatroom" style="display:none;">ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>
						<button class="create-button" id="edit-chatroom" style="display:none;">ì±„íŒ…ë°© ìˆ˜ì •</button>
						<button class="cancel-button" id="delete-chatroom"
							style="display:none; background-color: #f44336; color: white;">ì±„íŒ…ë°© ì‚­ì œ
						</button>
					</div>
				</div>
			</div>


			<!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ -->
			<div class="modal-overlay" id="create-chat-modal">
				<div class="modal">
					<div class="modal-header">
						<h3 class="modal-title">ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</h3>
						<div class="modal-close" id="close-create-modal">
							<i class="fas fa-times"></i>
						</div>
					</div>
					<div class="form-group">
						<label class="form-label">ì±„íŒ…ë°© ì œëª©</label>
						<input type="text" class="form-input" id="chat-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 30ì)"
							maxlength="30">
					</div>
					<div class="form-group">
						<label class="form-label">í•´ì‹œíƒœê·¸ (ìµœëŒ€ 5ê°œ)</label>
						<div class="hashtag-input">
						    <input type="text" class="hashtag-input-field" placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter...">
						</div>
					</div>
					<div class="form-group">
						<label class="form-label">ê³µì§€ì‚¬í•­ (ì„ íƒ)</label>
						<textarea class="form-textarea" id="chat-notice" placeholder="ì±„íŒ…ë°© ê³µì§€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 100ì)"
							maxlength="100"></textarea>
					</div>
					<div class="form-group">
						<label class="form-label">ì„¤ëª…ê¸€ (ì„ íƒ)</label>
						<textarea class="form-textarea" id="chat-description" placeholder="ì±„íŒ…ë°©ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 200ì)"
							maxlength="200"></textarea>
					</div>
					<div class="modal-footer">
						<button class="cancel-button" id="cancel-create">ì·¨ì†Œ</button>
						<button class="create-button" id="confirm-create">ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
					</div>
				</div>
			</div>
		</div>

		<!-- ì±„íŒ…ë°© ìˆ˜ì • ëª¨ë‹¬ -->
		<div class="modal-overlay" id="edit-chat-modal">
			<div class="modal">
				<div class="modal-header">
					<h3 class="modal-title">ì±„íŒ…ë°© ìˆ˜ì •</h3>
					<div class="modal-close" id="close-edit-modal">
						<i class="fas fa-times"></i>
					</div>
				</div>

				<div class="form-group">
					<label class="form-label">ì±„íŒ…ë°© ì œëª©</label>
					<input type="text" class="form-input" id="edit-chat-title" maxlength="30" />
				</div>

				<div class="form-group">
					<label class="form-label">í•´ì‹œíƒœê·¸ (ìµœëŒ€ 5ê°œ)</label>
					<div class="hashtag-input" id="edit-hashtag-container">
						<!-- ê¸°ì¡´ íƒœê·¸ ì±„ì›Œì§ -->
						<input type="text" class="hashtag-input-field" placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter..." />
					</div>
				</div>

				<div class="form-group">
					<label class="form-label">ê³µì§€ì‚¬í•­</label>
					<textarea class="form-textarea" id="edit-chat-notice" maxlength="100"></textarea>
				</div>

				<div class="form-group">
					<label class="form-label">ì„¤ëª…ê¸€</label>
					<textarea class="form-textarea" id="edit-chat-description" maxlength="200"></textarea>
				</div>

				<div class="modal-footer">
					<button class="cancel-button" id="cancel-edit">ì·¨ì†Œ</button>
					<button class="create-button" id="confirm-edit">ì €ì¥</button>
				</div>
			</div>
		</div>

		<style>
			.chat-room {
			    display: flex;
			    justify-content: space-between;
			    align-items: stretch;
			    background: white;
			    padding: 16px;
			    border-radius: 12px;
			    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
			    margin-bottom: 12px;
			    gap: 20px;
			}

			/* ì™¼ìª½: ì´ë¯¸ì§€ + ì°¸ì—¬ì ìˆ˜ */
			.chat-left {
			    display: flex;
			    flex-direction: column;
			    align-items: center;
			    width: 80px;
			    flex-shrink: 0;
			}

			.chat-avatar {
			    width: 60px;
			    height: 60px;
			    border-radius: 50%;
			    object-fit: cover;
			    margin-bottom: 8px;
			}

			.chat-participant-count {
			    font-size: 0.8rem;
			    padding: 4px 8px;
			    border-radius: 12px;
			    text-align: center;
			    white-space: nowrap;      /* âœ… ì¤„ë°”ê¿ˆ ë°©ì§€ */
			    max-width: 100%;          /* âœ… ì˜ì—­ ì´ˆê³¼ ë°©ì§€ */
			    margin-top: 6px;
			}
			/* ì¤‘ì•™ ë‚´ìš© */
			.chat-center {
			    flex: 1;
			    display: flex;
			    flex-direction: column;
			    justify-content: center;
			    gap: 8px;
			}

			.chat-title {
			    font-size: 1.1rem;
			    font-weight: 600;
			    background: #f7f7f7;
			    padding: 6px 12px;
			    border-radius: 10px;
			    width: fit-content;
			}

			.chat-hashtags {
			    display: flex;
			    flex-wrap: wrap;
			    gap: 6px;
			}

			.chat-hashtag {
			    background: #d5eef7;
			    color: #0077aa;
			    padding: 4px 10px;
			    border-radius: 16px;
			    font-size: 0.8rem;
			}

			.chat-owner {
			    font-size: 0.85rem;
			    color: #555;
			}

			/* ì˜¤ë¥¸ìª½: ì‹œê°„ ìœ„ / ì¢‹ì•„ìš” ì•„ë˜ */
			.chat-right {
			    display: flex;
			    flex-direction: column;
			    justify-content: space-between;
			    align-items: flex-end;
			    flex-shrink: 0;
			    min-width: 80px;
			}

			.chat-time {
			    font-size: 0.85rem;
			    color: #888;
			}

			.chat-likes {
			    font-size: 0.95rem;
			    color: #e74c3c;
			    font-weight: bold;
			}

		</style>


		<script>

			document.addEventListener('DOMContentLoaded', function () {
				// ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬
				const createChatBtn = document.getElementById('create-chat-btn');
				const createChatModal = document.getElementById('create-chat-modal');
				const closeCreateModal = document.getElementById('close-create-modal');
				const cancelCreate = document.getElementById('cancel-create');
				const confirmCreate = document.getElementById('confirm-create');
				const emptyStateBtn = document.querySelector('.create-first-chat');

				// í•´ì‹œíƒœê·¸ ì…ë ¥
				const hashtagInput = document.querySelector('.hashtag-input-field');
				const hashtagContainer = document.querySelector('.hashtag-input');
				const removeHashtags = document.querySelectorAll('.remove-hashtag');

				// ì±„íŒ…ë°© í•„í„°
				const chatFilters = document.querySelectorAll('.chat-filter');

				// ì±„íŒ…ë°© ëª©ë¡
				const chatRooms = document.querySelectorAll('.chat-room');

				// ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° í•¨ìˆ˜
				function openModal(modal) {
					modal.classList.add('active');
					document.body.style.overflow = 'hidden';
				}

				function closeModal(modal) {
					modal.classList.remove('active');
					document.body.style.overflow = '';
				}

				// ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ ì—´ê¸°
				createChatBtn.addEventListener('click', function () {
					openModal(createChatModal);
				});

				// ë¹ˆ ìƒíƒœì—ì„œ ì±„íŒ…ë°© ìƒì„± ë²„íŠ¼
				if (emptyStateBtn) {
					emptyStateBtn.addEventListener('click', function () {
						openModal(createChatModal);
					});
				}

				// ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ ë‹«ê¸°
				closeCreateModal.addEventListener('click', function () {
					closeModal(createChatModal);
				});

				cancelCreate.addEventListener('click', function () {
					closeModal(createChatModal);
				});

				// ì±„íŒ…ë°© ìƒì„± í™•ì¸
				confirmCreate.addEventListener('click', async function () {
					const title = document.getElementById('chat-title').value;
					const notice = document.getElementById('chat-notice').value;
					const description = document.getElementById('chat-description').value;

					// í•´ì‹œíƒœê·¸ ì¶”ì¶œ
					const hashtagElements = document.querySelectorAll('.hashtag');
					const hashtags = Array.from(hashtagElements).map(el => el.textContent.replace("Ã—", "").trim().replace("#", ""));

					if (!title) {
						alert('ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
						return;
					}

					try {
						// 1. ì±„íŒ…ë°© ìƒì„± ìš”ì²­
						const response = await fetch('/api/chatrooms', {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({title, notice, description, hashtags})
						});

						const newRoomId = await response.json();

						// 2. ì±„íŒ…ë°© ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
						const detailResponse = await fetch(`/api/chatrooms/${newRoomId}`);
						const room = await detailResponse.json();

						// 3. ëª©ë¡ì— ì±„íŒ…ë°© ë™ì  ì¶”ê°€
						const chatList = document.querySelector('.chat-list');
						const div = document.createElement('div');
						div.className = 'chat-room';
						div.setAttribute('data-id', room.id);
						div.innerHTML = `
						  <div class="chat-left">
						      <img src="${room.thumbnailImageUrl || '/api/placeholder/60/60'}" alt="ì±„íŒ…ë°© ì´ë¯¸ì§€" class="chat-avatar">
						      <div class="chat-participant-count">
						          ì°¸ì—¬ì: ${room.participantCount}ëª…
						      </div>
						  </div>
						  <div class="chat-center">
						      <div class="chat-title">${room.title}</div>
						      <div class="chat-hashtags">
						          ${room.hashtags.map(tag => `<div class="chat-hashtag">#${tag}</div>`).join("")}
						      </div>
						      <div class="chat-owner">ë°©ì¥: ${room.ownerNickname}</div>
						  </div>
						  <div class="chat-right">
						      <div class="chat-time">${new Date(room.createdAt).toLocaleString('ko-KR')}</div>
						      <div class="chat-likes">â¤ï¸ ${room.likeCount}</div>
						  </div>
						`;

						div.addEventListener('click', () => {
							window.location.href = `chat-detail.html?id=${room.id}`;
						});

						chatList.prepend(div);

						// ëª¨ë‹¬ ë‹«ê¸° ë° ì´ˆê¸°í™”
						closeModal(createChatModal);
						document.getElementById('chat-title').value = '';
						document.getElementById('chat-notice').value = '';
						document.getElementById('chat-description').value = '';
						document.querySelectorAll('.hashtag').forEach(el => el.remove());

					} catch (error) {
						alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
						console.error(error);
					}
				});

				// ì±„íŒ…ë°© ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
				document.getElementById('delete-chatroom').addEventListener('click', async () => {
					if (!selectedRoomId) return;

					if (!confirm("ì •ë§ ì´ ì±„íŒ…ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

					try {
						const res = await fetch(`/api/chatrooms/${selectedRoomId}`, {
							method: 'DELETE'
						});

						if (!res.ok) {
							const errorText = await res.text();
							throw new Error(errorText || "ì‚­ì œ ì‹¤íŒ¨");
						}

						alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
						window.location.reload();
					} catch (err) {
						alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
					}
				});



				//í•´ì‹œíƒœê·¸ ì…ë ¥ ì´ë²¤íŠ¸ ë“±ë¡ (ìƒì„± + ìˆ˜ì • í¼ ëª¨ë‘ ëŒ€ì‘)
				// - ìƒˆ íƒœê·¸ ìƒì„± ì‹œ "Ã—" í´ë¦­ìœ¼ë¡œ ì œê±° ê°€ëŠ¥
				// í•´ì‹œíƒœê·¸ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë°”ì¸ë”©í•˜ëŠ” í•¨ìˆ˜ (ìƒì„±/ìˆ˜ì • ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥)
				function bindHashtagInputs() {
					document.querySelectorAll('.hashtag-input-field').forEach(input => {
						input.removeEventListener('keydown', handleHashtagKeydown);
						input.addEventListener('keydown', handleHashtagKeydown);
					});
				}

				function handleHashtagKeydown(e) {
					if (e.key === 'Enter' && this.value.trim()) {
						e.preventDefault();

						const container = this.closest('.hashtag-input');
						const currentTags = container.querySelectorAll('.hashtag').length;

						if (currentTags >= 5) {
							alert('í•´ì‹œíƒœê·¸ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
							return;
						}

						const newTagText = this.value.trim();

						// âœ… ì¤‘ë³µ íƒœê·¸ ë°©ì§€
						const duplicate = [...container.querySelectorAll('.hashtag')].some(el =>
							el.textContent.replace("Ã—", "").trim().replace("#", "") === newTagText
						);
						if (duplicate) {
							alert('ì´ë¯¸ ì¶”ê°€ëœ í•´ì‹œíƒœê·¸ì…ë‹ˆë‹¤.');
							this.value = '';
							return;
						}

						const tag = document.createElement('div');
						tag.className = 'hashtag';
						tag.innerHTML = `#${newTagText} <span class="remove-hashtag">Ã—</span>`;
						tag.querySelector('.remove-hashtag').addEventListener('click', function () {
							tag.remove();
						});

						container.insertBefore(tag, this);
						this.value = '';
					}
				}
				// í•´ì‹œíƒœê·¸ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹¤í–‰ (ìƒì„± + ìˆ˜ì • í¼ ëª¨ë‘ ëŒ€ì‘)
				bindHashtagInputs();

				// ì±„íŒ…ë°© í•„í„° í´ë¦­ ì´ë²¤íŠ¸
				chatFilters.forEach(filter => {
					filter.addEventListener('click', function () {
						chatFilters.forEach(f => f.classList.remove('active'));
						this.classList.add('active');

						// ì‹¤ì œë¡œëŠ” í•„í„°ë§ ë¡œì§ ì¶”ê°€
					});
				});

				// ì±„íŒ…ë°© í´ë¦­ ì´ë²¤íŠ¸ (ì±„íŒ…ë°© ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™)
				// ì±„íŒ…ë°© ìƒì„¸ì •ë³´ ëª¨ë‹¬ ìš”ì†Œ ì •ì˜
				const detailModal = document.getElementById('chat-detail-modal');
				const closeDetailModal = document.getElementById('close-detail-modal');
				const enterChatroomBtn = document.getElementById('enter-chatroom');
				let selectedRoomId = null;

				// ê° ì±„íŒ…ë°© í´ë¦­ ì‹œ ìƒì„¸ì •ë³´ ëª¨ë‹¬ ë„ìš°ê¸°
				chatRooms.forEach(room => {
					room.addEventListener('click', async function () {
						const chatId = this.getAttribute('data-id');
						selectedRoomId = chatId;

						try {
							const res = await fetch(`/api/chatrooms/${chatId}`);
							const room = await res.json();

							// ì±„íŒ…ë°© ì •ë³´ ì„¸íŒ…
							document.getElementById('detail-title').textContent = room.title;
							document.getElementById('detail-description').textContent = room.description || '-';
							document.getElementById('detail-notice').textContent = room.notice || '-';
							document.getElementById('detail-hashtags').innerHTML = room.hashtags.map(tag => `<span>#${tag}</span>`).join(' ');

							// âœ… ì—­í•  ê¸°ë°˜ ë²„íŠ¼ í‘œì‹œ
							const role = room.myRole;

							if (role === 'OWNER') {
							    document.getElementById('edit-chatroom').style.display = 'inline-block';
							    document.getElementById('delete-chatroom').style.display = 'inline-block';
							    document.getElementById('leave-chatroom').style.display = 'none';
							} else if (role === 'JOINED') {
							    document.getElementById('edit-chatroom').style.display = 'none';
							    document.getElementById('delete-chatroom').style.display = 'none';
							    document.getElementById('leave-chatroom').style.display = 'inline-block';
							} else {
							    // ë¡œê·¸ì¸í–ˆì§€ë§Œ ì°¸ì—¬ ì•ˆí•œ ìœ ì € (ë˜ëŠ” null)
							    document.getElementById('edit-chatroom').style.display = 'none';
							    document.getElementById('delete-chatroom').style.display = 'none';
							    document.getElementById('leave-chatroom').style.display = 'none';
							}

							// ëª¨ë‹¬ ì—´ê¸°
							openModal(detailModal);
						} catch (err) {
							alert('ì±„íŒ…ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
							console.error(err);
						}
					});
				});


				// ìƒì„¸ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
				closeDetailModal.addEventListener('click', () => {
					closeModal(detailModal);
				});

				// ì…ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ chatroom.htmlë¡œ ì´ë™
				enterChatroomBtn.addEventListener('click', () => {
					if (selectedRoomId) {
						window.location.href = `chatroom.html?id=${selectedRoomId}`;
					}
				});

				const editChatroomBtn = document.getElementById('edit-chatroom');

				const editModal = document.getElementById('edit-chat-modal');
				const closeEditModal = document.getElementById('close-edit-modal');
				const cancelEditBtn = document.getElementById('cancel-edit');
				const confirmEditBtn = document.getElementById('confirm-edit');

				editChatroomBtn.addEventListener('click', async () => {
					if (!selectedRoomId) return;

					try {
						const res = await fetch(`/api/chatrooms/${selectedRoomId}`);
						const room = await res.json();

						// ê¸°ì¡´ ë‚´ìš© ì±„ìš°ê¸°
						document.getElementById('edit-chat-title').value = room.title || '';
						document.getElementById('edit-chat-notice').value = room.notice || '';
						document.getElementById('edit-chat-description').value = room.description || '';

						// í•´ì‹œíƒœê·¸
						const container = document.getElementById('edit-hashtag-container');
						container.querySelectorAll('.hashtag').forEach(el => el.remove());

						room.hashtags.forEach(tag => {
							const div = document.createElement('div');
							div.className = 'hashtag';
							div.innerHTML = `#${tag} <span class="remove-hashtag">Ã—</span>`;
							div.querySelector('.remove-hashtag').addEventListener('click', function () {
								div.remove();
							});
							container.insertBefore(div, container.querySelector('.hashtag-input-field'));
						});

						openModal(editModal);
					} catch (e) {
						alert('ìˆ˜ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
						console.error(e);
					}
				});

				confirmEditBtn.addEventListener('click', async () => {
					const title = document.getElementById('edit-chat-title').value;
					const notice = document.getElementById('edit-chat-notice').value;
					const description = document.getElementById('edit-chat-description').value;

					const hashtagElements = document.querySelectorAll('#edit-hashtag-container .hashtag');
					const hashtags = Array.from(hashtagElements).map(el => el.textContent.replace("Ã—", "").trim().replace("#", ""));

					if (!title) {
						alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
						return;
					}

					try {
						const res = await fetch(`/api/chatrooms/${selectedRoomId}/edit-log`, {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({title, notice, description, hashtags})
						});

						if (!res.ok) throw new Error('ìˆ˜ì • ì‹¤íŒ¨');

						alert('ì±„íŒ…ë°© ìˆ˜ì • ì™„ë£Œ!');
						closeModal(editModal);
						window.location.reload(); // ë˜ëŠ” ëª©ë¡ ë¦¬í”„ë ˆì‹œ ë¡œì§
					} catch (err) {
						alert('ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
						console.error(err);
					}
				});

				closeEditModal.addEventListener('click', () => closeModal(editModal));
				cancelEditBtn.addEventListener('click', () => closeModal(editModal));

				// ê²€ìƒ‰ ê¸°ëŠ¥
				const searchInput = document.querySelector('.search-input');
				searchInput.addEventListener('input', function () {
					const searchTerm = this.value.toLowerCase();

					chatRooms.forEach(room => {
						const title = room.querySelector('.chat-title').textContent.toLowerCase();
						const lastMessage = room.querySelector('.chat-last-message').textContent.toLowerCase();
						const hashtags = Array.from(room.querySelectorAll('.chat-hashtag')).map(tag => tag.textContent.toLowerCase());

						const matchTitle = title.includes(searchTerm);
						const matchMessage = lastMessage.includes(searchTerm);
						const matchHashtag = hashtags.some(tag => tag.includes(searchTerm));

						if (matchTitle || matchMessage || matchHashtag) {
							room.style.display = 'flex';
						} else {
							room.style.display = 'none';
						}
					});
				});
			})
		</script>
	</th:block>
</body>

</html>