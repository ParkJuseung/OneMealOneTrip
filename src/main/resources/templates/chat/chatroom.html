<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>ì±„íŒ…ë°©</title>
	<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	<style>
		body {
			font-family: 'Noto Sans KR', sans-serif;
			background: #f9f9f9;
			margin: 0;
			padding: 0;
		}

		.chat-box {
			font-size: 16px;
			max-width: 800px;
			margin: 30px auto;
			background: white;
			padding: 20px;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
			border-radius: 8px;
		}

		.messages {
			height: 400px;
			overflow-y: auto;
			border: 1px solid #ccc;
			padding: 10px;
			margin-bottom: 15px;
			background: #fff;
			border-radius: 4px;
		}

		.message {
			margin: 5px 0;
		}

		.message.you {
			text-align: right;
			color: #0ED8D5;
		}

		.message.other {
			text-align: left;
		}

		.message-time {
			display: block;
			font-size: 0.75em;
			color: #888;
			margin-top: 4px;
		}
		
		.message-ballon {
		    position: relative;
		    display: inline-block;
		    background: #484848;
		    color: white;
		    padding: 8px 12px;
		    border-radius: 8px;
		    max-width: 70%;
		    word-break: break-word;
		    font-size: 16px;
		}
		
		.you-ballon {
		    background: #0ED8D5;  /* âœ… íŒŒë€ìƒ‰ */
		    color: white;
		}
		
		.you-ballon::after {
		    display: none;
		}

		.message-ballon::after {
		    content: "";
		    position: absolute;
		    top: 50%;
		    left: -10px;
		    margin-top: -5px;
		    border-top: 5px solid transparent;
		    border-bottom: 5px solid transparent;
		    border-right: 10px solid #484848;
		}
		
		.other-ballon::after {
		    content: "";
		    position: absolute;
		    top: 60%; /* â¬…ï¸ ì¤‘ì•™ë³´ë‹¤ ì‚´ì§ ì•„ë˜ */
		    left: -10px;
		    transform: translateY(-50%);
		    border-top: 10px solid transparent;
		    border-bottom: 10px solid transparent;
		    border-right: 10px solid #484848;
			display: none;
		}

		.input-area {
			display: flex;
			gap: 10px;
		}

		#message {
			flex: 1;
			padding: 10px;
			border-radius: 4px;
			border: 1px solid #ccc;
		}

		#sendBtn {
			padding: 10px 20px;
			background: #0ED8D5;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}

		#sendBtn:hover {
			background: #04A6A4;
		}

		.divider-read-line {
			text-align: center;
			color: #888;
			font-size: 0.85em;
			font-style: italic;
			margin: 12px 0;
			padding: 5px 0;
			border-top: 1px dashed #ccc;
			border-bottom: 1px dashed #ccc;
			cursor: pointer;
		}
	</style>
</head>

<body>
	<div class="chat-box">
		<div style="display: flex; justify-content: space-between; align-items: center;">
			<h2 id="chatroom-title">ì±„íŒ…ë°© ì œëª© ë¡œë”©ì¤‘...</h2>
			<div style="display: flex; align-items: center; gap: 5px; cursor: pointer;" onclick="exitChatroom()">
				<span class="material-symbols-outlined" title="ì±„íŒ…ë°© ë‚˜ê°€ê¸°">logout</span>
				<span style="font-size: 16px;">ë‚˜ê°€ê¸°</span>
			</div>
		</div>

		<div class="messages" id="chat-messages"></div>
		<div class="input-area">
			<input type="text" id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
			<button id="sendBtn">ì „ì†¡</button>
		</div>
	</div>

	<script th:inline="javascript">
		const chatData = /*[[${chatData}]]*/ {};
		const chatRoomId = chatData.chatRoomId;
		const userId = chatData.userId;
		const nickname = chatData.nickname;
		const chatRoomTitle = chatData.chatRoomTitle;

		let isUserAtBottom = true;
		const messagesDiv = document.getElementById("chat-messages");

		function appendMessage(sender, content, isMine = false, messageId = null, allowAutoScroll = true, senderRole = '', createdAt = '') {
		    const div = document.createElement("div");
		    div.classList.add("message", isMine ? "you" : "other");
		    if (messageId !== null) div.dataset.messageId = messageId;

		    const crownIcon = senderRole === 'OWNER'
		        ? '<span class="material-symbols-outlined" style="font-size:16px; vertical-align:middle; color:gold;">crown</span> '
		        : '';

				if (isMine) {
				    div.innerHTML = `
				        <span style="font-size: 0.75em; color: #888; margin-right: 6px;">${createdAt}</span>
				        <span class="message-ballon you-ballon">${content}</span>
				    `;
				} else {
					div.innerHTML = `
					    <div style="display: flex; align-items: center; gap: 6px;">
					        <span style="margin-right: 4px; font-weight: normal;">${crownIcon}${sender}</span>
					        <div class="message-ballon other-ballon">${content}</div>
					        <span style="font-size: 0.75em; color: #888;">${createdAt}</span>
					    </div>
					`;
				}

		    const messagesDiv = document.getElementById("chat-messages");
		    messagesDiv.appendChild(div);

		    if (allowAutoScroll && isUserAtBottom) {
		        messagesDiv.scrollTop = messagesDiv.scrollHeight;
		    }
		}

		function loadGroupedMessages() {
			fetch(`/api/chatroom/${chatRoomId}/grouped-messages?userId=${userId}`)
				.then(response => response.json())
				.then(data => {
					messagesDiv.innerHTML = '';
					const messages = data.afterMessages;
					const lastReadId = data.lastReadMessageId;

					messages.forEach((msg, index) => {
						const isMine = String(msg.userId) === String(userId);

						// âœ… ì—¬ê¸°ì— ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€!
						console.log("ğŸ“¦ ê·¸ë£¹ ë©”ì‹œì§€:", msg.senderNickname, msg.senderRole);

						appendMessage(msg.senderNickname, msg.content, isMine, msg.messageId, false, msg.senderRole, msg.createdAt);

						const nextMsg = messages[index + 1];
						const isLastRead =
							msg.messageId === lastReadId ||
							(msg.messageId < lastReadId && (!nextMsg || nextMsg.messageId > lastReadId));

						if (isLastRead) {
							const divider = document.createElement("div");
							divider.classList.add("divider-read-line");
							divider.id = "read-divider";
							divider.dataset.hidden = "false";
							divider.innerText = "---- ì—¬ê¸°ê¹Œì§€ ì½ìœ¼ì…¨ìŠµë‹ˆë‹¤ ----";
							messagesDiv.appendChild(divider);
						}
					});

					if (messages.length > 0) {
						const lastMessageId = messages[messages.length - 1].messageId;

						fetch(`/api/chatroom/${chatRoomId}/read?userId=${userId}`, {
							method: 'POST',
							headers: {'Content-Type': 'application/json'},
							body: JSON.stringify({lastMessageId})
						}).then(res => {
							if (!res.ok) console.error("âŒ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨", res.status);
						});
					}

					messagesDiv.scrollTop = messagesDiv.scrollHeight;
				});
		}

		function loadPreviousMessages(beforeMessageId) {
			messagesDiv.classList.add("loading");

			const loading = document.createElement("div");
			loading.id = "loading-indicator";
			loading.innerText = "â³ ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
			loading.style.textAlign = "center";
			messagesDiv.prepend(loading);

			fetch(`/api/chatroom/${chatRoomId}/previous-messages?before=${beforeMessageId}&userId=${userId}`)
				.then(response => response.json())
				.then(messages => {
					loading.remove();
					messagesDiv.classList.remove("loading");

					messages.reverse().forEach(msg => {
						const isMine = String(msg.userId) === String(userId);
						appendMessage(msg.senderNickname, msg.content, isMine, msg.messageId, false, msg.senderRole, msg.createdAt);
					});
				});
		}

		function sendMessage() {
			const input = document.getElementById("message");
			const content = input.value.trim();
			if (!content) return;

			const dto = {
				chatRoomId,
				userId,
				content,
				messageType: "TEXT"
			};

			stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(dto));
			input.value = '';
		}

		const socket = new SockJS("/ws-stomp");
		const stompClient = Stomp.over(socket);

		stompClient.connect({}, function () {
			stompClient.subscribe(`/topic/chatroom.${chatRoomId}`, function (message) {
				const body = JSON.parse(message.body);
				const isMine = String(body.userId) === String(userId);

				// âœ… ì—¬ê¸°ë„ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€!
				console.log("ğŸŸ¢ ì‹¤ì‹œê°„ ë©”ì‹œì§€:", body.senderNickname, body.senderRole);

				appendMessage(body.senderNickname, body.content, isMine, null, true, body.senderRole, body.createdAt);
			});
		});

		function exitChatroom() {
			if (confirm("ì •ë§ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
				fetch(`/api/chatrooms/${chatRoomId}/exit`, {method: "POST"})
					.then(response => {
						if (response.ok) {
							alert("ì±„íŒ…ë°©ì„ ë‚˜ê°€ì…¨ìŠµë‹ˆë‹¤.");
							window.close();
							setTimeout(() => window.location.href = "/chat", 200);
						} else {
							return response.text().then(msg => {throw new Error(msg);});
						}
					})
					.catch(err => alert("ë‚˜ê°€ê¸° ì‹¤íŒ¨: " + err.message));
			}
		}

		document.addEventListener("DOMContentLoaded", () => {
			document.getElementById("chatroom-title").textContent = chatRoomTitle;
			loadGroupedMessages();

			document.getElementById("sendBtn").addEventListener("click", sendMessage);
			document.getElementById("message").addEventListener("keydown", function (e) {
				if (e.key === "Enter" && !e.shiftKey) {
					e.preventDefault();
					sendMessage();
				}
			});

			messagesDiv.addEventListener("scroll", () => {
				const tolerance = 10;
				const distanceToBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop - messagesDiv.clientHeight;
				isUserAtBottom = distanceToBottom <= tolerance;

				if (messagesDiv.scrollTop === 0 && !messagesDiv.classList.contains("loading")) {
					const firstMsg = messagesDiv.querySelector(".message");
					if (firstMsg) {
						const beforeMessageId = parseInt(firstMsg.dataset.messageId);
						loadPreviousMessages(beforeMessageId);
					}
				}
			});
		});

		document.addEventListener("click", function (e) {
			if (e.target.id === "read-divider") {
				const el = e.target;
				el.style.display = el.dataset.hidden === "true" ? "block" : "none";
				el.dataset.hidden = el.dataset.hidden === "true" ? "false" : "true";
			}
		});
	</script>
</body>

</html>