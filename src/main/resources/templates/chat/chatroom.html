<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채팅방</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
        .chat-box { max-width: 800px; margin: 30px auto; background: white; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px; }
        .messages { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; background: #fff; border-radius: 4px; }
        .message { margin: 5px 0; }
        .message.you { text-align: right; color: #0ED8D5; }
        .message.other { text-align: left; }
        .input-area { display: flex; gap: 10px; }
        #message { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        #sendBtn { padding: 10px 20px; background: #0ED8D5; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #sendBtn:hover { background: #04A6A4; }
    </style>
</head>
<body>
<div class="chat-box">
    <h2 id="chatroom-title">채팅방 제목 로딩중...</h2>
    <div class="messages" id="chat-messages"></div>

    <div class="input-area">
        <input type="text" id="message" placeholder="메시지를 입력하세요...">
        <button id="sendBtn">전송</button>
    </div>
</div>

<script th:inline="javascript">
    const chatData = /*[[${chatData}]]*/ {};
    const chatRoomId = chatData.chatRoomId;
    const userId = chatData.userId;
    const nickname = chatData.nickname;
    const chatRoomTitle = chatData.chatRoomTitle;

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("chatroom-title").textContent = `채팅방 # ${chatRoomTitle}`;
    });

    const socket = new SockJS('/ws-stomp');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {
        stompClient.subscribe('/topic/chatroom.' + chatRoomId, function (message) {
            const body = JSON.parse(message.body);
			
			 //console.log("📩 받은 메시지:", body);
			 //console.log("✅ 비교: body.userId =", body.userId, ", 내 userId =", userId);
			 //console.log("💡 userId (HTML에서 받은 값):", userId);
			
            const isMine = String(body.userId) === String(userId);
            appendMessage(body.senderNickname, body.content, isMine);
        });
    });

    function sendMessage() {
        const input = document.getElementById('message');
        const content = input.value.trim();
        if (!content) return;

        const dto = {
            chatRoomId: chatRoomId,
            userId: userId,
            content: content,
            messageType: 'TEXT'
        };

        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(dto));
        input.value = '';
    }

    document.getElementById('sendBtn').addEventListener('click', sendMessage);

    document.getElementById('message').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function appendMessage(sender, content, isMine = false) {
        const div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(isMine ? 'you' : 'other');
        div.innerText = isMine ? content : `${sender}: ${content}`;

        const messagesDiv = document.getElementById('chat-messages');
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>